<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logarithms &amp; Exponentials</title>
    <meta name="description" content="Explore logarithms and exponentials as inverse functions. Interactive graphs showing growth, decay, and the natural logarithm.">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#0a0a1a;color:#e0e0e0;font-family:Georgia,'Times New Roman',serif;line-height:1.6}
        .container{max-width:960px;margin:0 auto;padding:24px 28px 48px}
        .back{color:#606078;text-decoration:none;font-size:0.85em}
        .back:hover{color:#60a5fa}
        h1{font-size:1.8em;font-weight:400;color:#fff;margin:16px 0 4px}
        .subtitle{color:#808098;font-style:italic;margin-bottom:28px}
        h2{font-size:1.15em;font-weight:400;color:#fff;margin:28px 0 12px}
        canvas{display:block;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:crosshair}
        .panel{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:18px 22px;margin-bottom:20px}
        .panel h3{font-weight:400;font-size:0.8em;color:#808098;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
        .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
        .btn{background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.07);color:#b0b0c4;padding:5px 13px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:0.92em;transition:all 0.2s}
        .btn:hover{background:rgba(255,255,255,0.07);color:#e0e0ef}
        .btn.active{background:rgba(96,165,250,0.13);border-color:rgba(96,165,250,0.4);color:#60a5fa}
        .math-line{font-family:'Courier New',monospace;font-size:0.92em;color:#c0c0d8;margin:4px 0;line-height:1.8}
        .math-line .blue{color:#60a5fa}.math-line .gold{color:#fbbf24}.math-line .green{color:#2ecc71}
        .math-line .muted{color:#808098}
        .explain{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:20px 24px;margin-top:20px}
        .explain-name{color:#60a5fa;font-size:1.1em;margin-bottom:6px}
        .explain-text{color:#a0a0b8;font-size:0.9em;line-height:1.75}
        .slider-row{display:flex;align-items:center;gap:14px;margin:10px 0}
        .slider-row input[type=range]{flex:1;max-width:260px;accent-color:#60a5fa}
        .slider-label{color:#60a5fa;font-family:'Courier New',monospace;font-size:1.05em;min-width:50px}
        .flex-row{display:flex;gap:20px;flex-wrap:wrap}
        .flex-row>.flex-half{flex:1 1 300px;min-width:280px}
        .law-panel{background:rgba(255,255,255,0.018);border:1px solid rgba(255,255,255,0.05);border-radius:8px;padding:14px 18px;margin-bottom:14px}
        .law-panel h4{font-weight:400;font-size:0.85em;color:#60a5fa;margin-bottom:8px}
        .law-result{font-family:'Courier New',monospace;font-size:0.88em;color:#c0c0d8;margin:6px 0;line-height:1.8}
        .law-result .eq{color:#2ecc71}
        .obs-box{background:rgba(96,165,250,0.06);border-left:2px solid rgba(96,165,250,0.3);padding:10px 14px;margin:10px 0;border-radius:0 6px 6px 0}
        .obs-box p{color:#a0a0b8;font-size:0.88em;line-height:1.7;margin:3px 0}
        .obs-box .highlight{color:#60a5fa}
        .dual-canvas{display:flex;gap:16px;flex-wrap:wrap}
        .dual-canvas canvas{flex:1 1 320px;min-width:280px}
        .calc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;margin:10px 0}
        .calc-grid .slider-row{margin:4px 0}
        .example-list{color:#a0a0b8;font-size:0.88em;line-height:1.9;margin:10px 0}
        .example-list .label{color:#60a5fa;font-family:'Courier New',monospace}
        @media(max-width:600px){canvas{width:100%!important;height:auto!important}.dual-canvas{flex-direction:column}.calc-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <a class="back" href="index.html">&larr; Back to Index</a>
    <h1>Logarithms &amp; Exponentials</h1>
    <p class="subtitle">Growth, decay, and the inverse that tames infinity</p>

    <!-- ═══════════════════ Section 1: Exponential Functions ═══════════════════ -->
    <h2>1. Exponential Functions</h2>
    <canvas id="expCanvas" width="700" height="400"></canvas>
    <div class="panel" style="margin-top:14px">
        <h3>Base Control</h3>
        <div class="slider-row">
            <span class="math-line muted">b =</span>
            <input type="range" id="expBaseSlider" min="0.1" max="5.0" step="0.01" value="2.72">
            <span class="slider-label" id="expBaseLabel">2.72</span>
        </div>
        <h3 style="margin-top:12px">Show Standard Bases</h3>
        <div class="btn-row" id="expToggles"></div>
        <div id="expSlopeInfo" class="math-line" style="margin-top:8px"></div>
    </div>
    <div class="obs-box">
        <p><span class="highlight">b &gt; 1:</span> exponential growth &mdash; steeper with larger b</p>
        <p><span class="highlight">b = 1:</span> flat line y = 1</p>
        <p><span class="highlight">0 &lt; b &lt; 1:</span> exponential decay</p>
        <p><span class="highlight">All pass through (0, 1)</span></p>
        <p style="margin-top:6px"><span class="highlight">e &asymp; 2.718:</span> The natural base &mdash; the one that is its own derivative. At x = 0, the slope of e<sup>x</sup> is exactly 1. Compare: 2<sup>x</sup> has slope 0.693, 3<sup>x</sup> has slope 1.099 &mdash; only e<sup>x</sup> has slope 1.</p>
    </div>

    <!-- ═══════════════════ Section 2: The Logarithm as Inverse ═══════════════════ -->
    <h2>2. The Logarithm as Inverse</h2>
    <canvas id="logCanvas" width="700" height="400"></canvas>
    <div class="panel" style="margin-top:14px">
        <h3>Base Selector</h3>
        <div class="btn-row" id="logBaseBtns"></div>
        <div style="margin-top:10px">
            <button class="btn" id="reflectBtn">Animate Reflection</button>
            <span class="math-line muted" id="reflectStatus" style="margin-left:12px"></span>
        </div>
        <div id="logClickInfo" class="math-line" style="margin-top:8px"></div>
    </div>
    <div class="obs-box">
        <p><span class="highlight">log<sub>b</sub>(1) = 0</span> always &mdash; any base raised to 0 is 1</p>
        <p><span class="highlight">log<sub>b</sub>(b) = 1</span> always &mdash; any base raised to 1 is itself</p>
        <p><span class="highlight">log<sub>b</sub>(xy) = log<sub>b</sub>(x) + log<sub>b</sub>(y)</span> &mdash; logs turn multiplication into addition</p>
        <p><span class="highlight">log<sub>b</sub>(x<sup>n</sup>) = n &middot; log<sub>b</sub>(x)</span> &mdash; logs turn powers into multiplication</p>
        <p style="margin-top:4px">Domain/range: exponential has range (0, &infin;), so log has domain (0, &infin;)</p>
    </div>

    <!-- ═══════════════════ Section 3: Log Laws Interactive Verifier ═══════════════════ -->
    <h2>3. Log Laws &mdash; Interactive Verifier</h2>

    <div class="law-panel">
        <h4>Product Rule: log(xy) = log(x) + log(y)</h4>
        <div class="slider-row">
            <span class="math-line muted">x =</span>
            <input type="range" id="prodX" min="0.1" max="20" step="0.1" value="4">
            <span class="slider-label" id="prodXLabel">4.0</span>
        </div>
        <div class="slider-row">
            <span class="math-line muted">y =</span>
            <input type="range" id="prodY" min="0.1" max="20" step="0.1" value="5">
            <span class="slider-label" id="prodYLabel">5.0</span>
        </div>
        <div id="prodResult" class="law-result"></div>
    </div>

    <div class="law-panel">
        <h4>Quotient Rule: log(x/y) = log(x) - log(y)</h4>
        <div class="slider-row">
            <span class="math-line muted">x =</span>
            <input type="range" id="quotX" min="0.1" max="20" step="0.1" value="8">
            <span class="slider-label" id="quotXLabel">8.0</span>
        </div>
        <div class="slider-row">
            <span class="math-line muted">y =</span>
            <input type="range" id="quotY" min="0.1" max="20" step="0.1" value="2">
            <span class="slider-label" id="quotYLabel">2.0</span>
        </div>
        <div id="quotResult" class="law-result"></div>
    </div>

    <div class="law-panel">
        <h4>Power Rule: log(x<sup>n</sup>) = n &middot; log(x)</h4>
        <div class="slider-row">
            <span class="math-line muted">x =</span>
            <input type="range" id="powX" min="0.1" max="20" step="0.1" value="3">
            <span class="slider-label" id="powXLabel">3.0</span>
        </div>
        <div class="slider-row">
            <span class="math-line muted">n =</span>
            <input type="range" id="powN" min="-4" max="8" step="0.1" value="2">
            <span class="slider-label" id="powNLabel">2.0</span>
        </div>
        <div id="powResult" class="law-result"></div>
    </div>

    <div class="law-panel">
        <h4>Change of Base: log<sub>a</sub>(x) = log<sub>b</sub>(x) / log<sub>b</sub>(a)</h4>
        <div class="slider-row">
            <span class="math-line muted">x =</span>
            <input type="range" id="cobX" min="0.1" max="100" step="0.1" value="8">
            <span class="slider-label" id="cobXLabel">8.0</span>
        </div>
        <div class="btn-row" style="margin-top:6px">
            <span class="math-line muted" style="margin-right:4px">from base</span>
            <button class="btn active" data-cob-from="2">2</button>
            <button class="btn" data-cob-from="e">e</button>
            <button class="btn" data-cob-from="10">10</button>
            <span class="math-line muted" style="margin-left:10px;margin-right:4px">via base</span>
            <button class="btn" data-cob-via="2">2</button>
            <button class="btn active" data-cob-via="e">e</button>
            <button class="btn" data-cob-via="10">10</button>
        </div>
        <div id="cobResult" class="law-result" style="margin-top:8px"></div>
    </div>

    <!-- ═══════════════════ Section 4: Log Scales ═══════════════════ -->
    <h2>4. Log Scales &mdash; Why Logs Matter</h2>
    <div class="dual-canvas">
        <canvas id="linearCanvas" width="340" height="350"></canvas>
        <canvas id="logScaleCanvas" width="340" height="350"></canvas>
    </div>
    <div class="panel" style="margin-top:14px">
        <h3>Growth Rate</h3>
        <div class="slider-row">
            <span class="math-line muted">rate =</span>
            <input type="range" id="growthSlider" min="0.5" max="4.0" step="0.01" value="2.0">
            <span class="slider-label" id="growthLabel">2.00</span>
            <span class="math-line muted" style="margin-left:8px">(y = rate<sup>x</sup>)</span>
        </div>
    </div>
    <div class="obs-box">
        <p><span class="highlight">Linear scale:</span> the curve shoots up; early data is invisible, late data dominates.</p>
        <p><span class="highlight">Log scale:</span> exponential growth becomes a straight line. The slope reveals the growth rate.</p>
    </div>
    <div class="example-list">
        <p><span class="label">Richter scale</span> &mdash; each unit = 10x more energy released</p>
        <p><span class="label">Decibels</span> &mdash; sound intensity on a logarithmic scale</p>
        <p><span class="label">pH scale</span> &mdash; each unit = 10x change in hydrogen ion concentration</p>
        <p><span class="label">Stock prices</span> &mdash; log returns are additive across time periods</p>
    </div>

    <!-- ═══════════════════ Section 5: Compound Interest & e ═══════════════════ -->
    <h2>5. Compound Interest &amp; the Birth of e</h2>
    <canvas id="compoundCanvas" width="600" height="350"></canvas>
    <div class="panel" style="margin-top:14px">
        <h3>Compounding Frequency: A = P(1 + r/n)<sup>nt</sup></h3>
        <p class="math-line muted" style="margin-bottom:8px">P = 1, r = 100%, t = 1 year &mdash; how does A change with n?</p>
        <div class="slider-row">
            <span class="math-line muted">n =</span>
            <input type="range" id="compoundN" min="0" max="6" step="1" value="0">
            <span class="slider-label" id="compoundNLabel">1</span>
            <span class="math-line muted" id="compoundNName" style="margin-left:4px">(annual)</span>
        </div>
        <div id="compoundResult" class="math-line" style="margin-top:6px"></div>
    </div>

    <div class="panel">
        <h3>General Compound Interest Calculator</h3>
        <div class="calc-grid">
            <div class="slider-row">
                <span class="math-line muted">P =</span>
                <input type="range" id="calcP" min="100" max="10000" step="100" value="1000">
                <span class="slider-label" id="calcPLabel">1000</span>
            </div>
            <div class="slider-row">
                <span class="math-line muted">r =</span>
                <input type="range" id="calcR" min="1" max="20" step="0.5" value="7">
                <span class="slider-label" id="calcRLabel">7%</span>
            </div>
            <div class="slider-row">
                <span class="math-line muted">t =</span>
                <input type="range" id="calcT" min="1" max="30" step="1" value="10">
                <span class="slider-label" id="calcTLabel">10 yr</span>
            </div>
            <div class="slider-row">
                <span class="math-line muted">n =</span>
                <input type="range" id="calcFreq" min="0" max="5" step="1" value="2">
                <span class="slider-label" id="calcFreqLabel">quarterly</span>
            </div>
        </div>
        <canvas id="growthCurveCanvas" width="600" height="280" style="margin-top:10px;cursor:default"></canvas>
        <div id="calcResult" class="math-line" style="margin-top:8px"></div>
        <div id="rule72" class="math-line" style="margin-top:4px"></div>
    </div>

    <!-- ═══════════════════ Section 6: Explanation Panel ═══════════════════ -->
    <div class="explain" style="margin-top:28px">
        <div class="explain-name">What have we learnt?</div>
        <div class="explain-text">
            <p>Logarithms and exponentials are inverses &mdash; one describes growth, the other measures it. The exponential function models how things multiply over time: populations, investments, radioactive decay. The logarithm is the tool that tames these numbers back to a human scale.</p>
            <p style="margin-top:10px">The number e &asymp; 2.718 emerges naturally from compound interest taken to its limit: it is the base whose exponential is its own derivative, making it the universal language of continuous growth and decay.</p>
            <p style="margin-top:10px">Logarithmic scales &mdash; Richter, decibels, pH, stock returns &mdash; exploit the fact that logs compress vast ranges into manageable ones and turn multiplicative processes into additive ones.</p>
            <p style="margin-top:10px"><strong style="color:#60a5fa">Bridge to finance:</strong> Log returns are additive across time periods, making them the natural language of quantitative finance. Compound interest is the foundation of discounting future cash flows, the Black-Scholes formula uses ln(S/K), and exponential discounting governs how we value money across time.</p>
            <p style="margin-top:10px"><strong style="color:#808098">Historical note:</strong> John Napier published his invention of logarithms in 1614, primarily to simplify the tedious multiplication required by astronomers. Kepler himself wrote to Napier thanking him, and Laplace later remarked that logarithms, by shortening the labour, doubled the life of the astronomer.</p>
        </div>
    </div>
</div>

<script>
/* ════════════════════════════════════════════════════════════════
   Section 1: Exponential Functions
   ════════════════════════════════════════════════════════════════ */
const E = Math.E;

// Standard bases with toggle state
const stdBases = [
    {value:0.5, label:'0.5', color:'#e879f9', on:false},
    {value:1,   label:'1',   color:'#808098', on:false},
    {value:2,   label:'2',   color:'#fbbf24', on:false},
    {value:E,   label:'e',   color:'#2ecc71', on:true},
    {value:3,   label:'3',   color:'#f97316', on:false},
    {value:10,  label:'10',  color:'#ef4444', on:false}
];

(function initExpToggles(){
    const c = document.getElementById('expToggles');
    c.innerHTML = stdBases.map((b,i)=>
        '<button class="btn'+(b.on?' active':'')+'" data-ei="'+i+'">b = '+b.label+'</button>'
    ).join('');
    c.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const idx = parseInt(btn.dataset.ei);
            stdBases[idx].on = !stdBases[idx].on;
            btn.classList.toggle('active');
            drawExp();
        });
    });
})();

const expCvs = document.getElementById('expCanvas'), expCtx = expCvs.getContext('2d');
const expW = expCvs.width, expH = expCvs.height;
const expSlider = document.getElementById('expBaseSlider');
const expLabel = document.getElementById('expBaseLabel');

function drawExp(){
    const b = parseFloat(expSlider.value);
    expLabel.textContent = b.toFixed(2);
    const cx = expCtx;
    cx.clearRect(0,0,expW,expH);
    cx.fillStyle='#0a0a1a'; cx.fillRect(0,0,expW,expH);

    // Coordinate system: x from -3 to 5, y from -0.5 to 8
    const xMin=-3, xMax=5, yMin=-0.5, yMax=8;
    function tx(x){return (x-xMin)/(xMax-xMin)*expW;}
    function ty(y){return expH - (y-yMin)/(yMax-yMin)*expH;}

    // Grid
    cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
    for(let gx=Math.ceil(xMin);gx<=Math.floor(xMax);gx++){
        cx.beginPath();cx.moveTo(tx(gx),0);cx.lineTo(tx(gx),expH);cx.stroke();
    }
    for(let gy=Math.ceil(yMin);gy<=Math.floor(yMax);gy++){
        cx.beginPath();cx.moveTo(0,ty(gy));cx.lineTo(expW,ty(gy));cx.stroke();
    }

    // Axes
    cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
    cx.beginPath();cx.moveTo(0,ty(0));cx.lineTo(expW,ty(0));cx.stroke();
    cx.beginPath();cx.moveTo(tx(0),0);cx.lineTo(tx(0),expH);cx.stroke();

    // Tick labels
    cx.font='10px Georgia'; cx.fillStyle='#505068';
    cx.textAlign='center'; cx.textBaseline='top';
    for(let gx=Math.ceil(xMin);gx<=Math.floor(xMax);gx++){
        if(gx===0) continue;
        cx.fillText(gx, tx(gx), ty(0)+4);
    }
    cx.textAlign='right'; cx.textBaseline='middle';
    for(let gy=1;gy<=Math.floor(yMax);gy++){
        cx.fillText(gy, tx(0)-6, ty(gy));
    }

    // Axis labels
    cx.font='13px Georgia'; cx.fillStyle='#808098';
    cx.textAlign='left'; cx.textBaseline='bottom';
    cx.fillText('x', expW-20, ty(0)-6);
    cx.textAlign='left'; cx.textBaseline='top';
    cx.fillText('y', tx(0)+8, 6);

    // Plot standard bases that are toggled on
    stdBases.forEach(sb=>{
        if(!sb.on) return;
        cx.strokeStyle=sb.color; cx.lineWidth=1.5; cx.globalAlpha=0.6;
        cx.beginPath();
        let started=false;
        for(let px=0;px<=expW;px+=2){
            const x=xMin+(xMax-xMin)*px/expW;
            const y=Math.pow(sb.value,x);
            if(y<yMin||y>yMax*1.5){started=false;continue;}
            if(!started){cx.moveTo(px,ty(y));started=true;}
            else cx.lineTo(px,ty(y));
        }
        cx.stroke();
        cx.globalAlpha=1;
        // Label
        const labelX=2.5;
        const labelY=Math.pow(sb.value,labelX);
        if(labelY>yMin&&labelY<yMax){
            cx.font='11px Georgia'; cx.fillStyle=sb.color; cx.globalAlpha=0.8;
            cx.textAlign='left'; cx.textBaseline='bottom';
            cx.fillText(sb.label==='e'?'e^x':sb.label+'^x', tx(labelX)+4, ty(labelY)-4);
            cx.globalAlpha=1;
        }
    });

    // Plot current slider base (bold)
    cx.strokeStyle='#60a5fa'; cx.lineWidth=2.5; cx.globalAlpha=1;
    cx.beginPath();
    let started=false;
    for(let px=0;px<=expW;px+=2){
        const x=xMin+(xMax-xMin)*px/expW;
        const y=Math.pow(b,x);
        if(y<yMin||y>yMax*1.5){started=false;continue;}
        if(!started){cx.moveTo(px,ty(y));started=true;}
        else cx.lineTo(px,ty(y));
    }
    cx.stroke();

    // Point (0, 1)
    cx.fillStyle='#60a5fa';
    cx.beginPath();cx.arc(tx(0),ty(1),5,0,Math.PI*2);cx.fill();
    cx.font='11px Georgia'; cx.textAlign='left'; cx.textBaseline='bottom';
    cx.fillText('(0, 1)', tx(0)+8, ty(1)-4);

    // Tangent line at x=0 for current base
    const slope = Math.log(b); // derivative of b^x at x=0 is ln(b)
    cx.setLineDash([4,4]);
    cx.strokeStyle='rgba(96,165,250,0.5)'; cx.lineWidth=1.5;
    cx.beginPath();
    cx.moveTo(tx(-2), ty(1 + slope*(-2)));
    cx.lineTo(tx(2), ty(1 + slope*(2)));
    cx.stroke();
    cx.setLineDash([]);

    // Slope info
    const slopeInfo = document.getElementById('expSlopeInfo');
    slopeInfo.innerHTML = '<span class="blue">b = '+b.toFixed(2)+'</span> <span class="muted">&ensp;slope at x=0: ln('+b.toFixed(2)+') = '+slope.toFixed(4)+'</span>';
    if(Math.abs(b-E)<0.02){
        slopeInfo.innerHTML += ' <span class="green">&ensp;slope = 1 exactly (this is e!)</span>';
    }

    // Label current base curve
    const curLabelX=3;
    const curLabelY=Math.pow(b,curLabelX);
    if(curLabelY>yMin&&curLabelY<yMax-0.5){
        cx.font='12px Georgia'; cx.fillStyle='#60a5fa';
        cx.textAlign='left'; cx.textBaseline='bottom';
        cx.fillText('b='+b.toFixed(2), tx(curLabelX)+6, ty(curLabelY)-6);
    }
}

expSlider.addEventListener('input', drawExp);
drawExp();


/* ════════════════════════════════════════════════════════════════
   Section 2: The Logarithm as Inverse
   ════════════════════════════════════════════════════════════════ */
const logCvs = document.getElementById('logCanvas'), logCtx = logCvs.getContext('2d');
const logW = logCvs.width, logH = logCvs.height;

let logBase = E; // current base
let logBaseName = 'e';
let reflectAnim = null; // animation state

const logBases = [
    {value:2, label:'log\u2082', name:'2'},
    {value:E, label:'ln', name:'e'},
    {value:10, label:'log\u2081\u2080', name:'10'}
];

(function initLogBtns(){
    const c=document.getElementById('logBaseBtns');
    c.innerHTML=logBases.map((lb,i)=>
        '<button class="btn'+(lb.name==='e'?' active':'')+'" data-li="'+i+'">'+lb.label+'</button>'
    ).join('');
    c.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            c.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const lb=logBases[parseInt(btn.dataset.li)];
            logBase=lb.value; logBaseName=lb.name;
            reflectAnim=null;
            drawLog();
        });
    });
})();

function drawLog(animFrac){
    const cx=logCtx;
    cx.clearRect(0,0,logW,logH);
    cx.fillStyle='#0a0a1a'; cx.fillRect(0,0,logW,logH);

    const xMin=-3, xMax=8, yMin=-3, yMax=8;
    function tx(x){return (x-xMin)/(xMax-xMin)*logW;}
    function ty(y){return logH - (y-yMin)/(yMax-yMin)*logH;}

    // Grid
    cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
    for(let gx=Math.ceil(xMin);gx<=Math.floor(xMax);gx++){
        cx.beginPath();cx.moveTo(tx(gx),0);cx.lineTo(tx(gx),logH);cx.stroke();
    }
    for(let gy=Math.ceil(yMin);gy<=Math.floor(yMax);gy++){
        cx.beginPath();cx.moveTo(0,ty(gy));cx.lineTo(logW,ty(gy));cx.stroke();
    }

    // Axes
    cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
    cx.beginPath();cx.moveTo(0,ty(0));cx.lineTo(logW,ty(0));cx.stroke();
    cx.beginPath();cx.moveTo(tx(0),0);cx.lineTo(tx(0),logH);cx.stroke();

    // Tick labels
    cx.font='10px Georgia'; cx.fillStyle='#505068';
    cx.textAlign='center'; cx.textBaseline='top';
    for(let gx=Math.ceil(xMin);gx<=Math.floor(xMax);gx++){
        if(gx===0) continue;
        cx.fillText(gx, tx(gx), ty(0)+4);
    }
    cx.textAlign='right'; cx.textBaseline='middle';
    for(let gy=Math.ceil(yMin);gy<=Math.floor(yMax);gy++){
        if(gy===0) continue;
        cx.fillText(gy, tx(0)-6, ty(gy));
    }

    // y = x reflection line (dashed)
    cx.setLineDash([4,4]);
    cx.strokeStyle='rgba(255,255,255,0.15)'; cx.lineWidth=1;
    cx.beginPath();cx.moveTo(tx(xMin),ty(xMin));cx.lineTo(tx(xMax),ty(xMax));cx.stroke();
    cx.setLineDash([]);
    cx.font='11px Georgia'; cx.fillStyle='rgba(255,255,255,0.25)';
    cx.textAlign='left'; cx.textBaseline='bottom';
    cx.fillText('y = x', tx(6)+4, ty(6)-4);

    // Exponential curve: y = b^x
    cx.strokeStyle='#60a5fa'; cx.lineWidth=2;
    cx.beginPath();
    let expStarted=false;
    for(let px=0;px<=logW;px+=2){
        const x=xMin+(xMax-xMin)*px/logW;
        const y=Math.pow(logBase,x);
        if(y<yMin||y>yMax*1.2){expStarted=false;continue;}
        if(!expStarted){cx.moveTo(px,ty(y));expStarted=true;}
        else cx.lineTo(px,ty(y));
    }
    cx.stroke();

    // Label for exponential
    cx.font='12px Georgia'; cx.fillStyle='#60a5fa';
    cx.textAlign='left'; cx.textBaseline='bottom';
    const eLabelX=1.5;
    const eLabelY=Math.pow(logBase,eLabelX);
    if(eLabelY>yMin&&eLabelY<yMax){
        cx.fillText('y = '+logBaseName+'^x', tx(eLabelX)+6, ty(eLabelY)-6);
    }

    // Determine animation progress
    const frac = typeof animFrac === 'number' ? animFrac : 1;

    // Log curve: animated or static
    if(frac > 0){
        // Interpolate points from exponential to log
        cx.strokeStyle='#fbbf24'; cx.lineWidth=2;
        cx.beginPath();
        let logStarted=false;
        for(let px=0;px<=logW;px+=2){
            const x=xMin+(xMax-xMin)*px/logW;
            if(x<=0.01) continue;
            // The log curve point
            const logY = Math.log(x)/Math.log(logBase);
            // The corresponding exponential point (reflected)
            const expPtX = logY; // this is the x on exponential
            const expPtY = x;   // this is the y on exponential
            // Interpolate
            const drawX = expPtX + frac*(x - expPtX);
            const drawY = expPtY + frac*(logY - expPtY);
            if(drawY<yMin||drawY>yMax*1.2||drawX<xMin||drawX>xMax){logStarted=false;continue;}
            if(!logStarted){cx.moveTo(tx(drawX),ty(drawY));logStarted=true;}
            else cx.lineTo(tx(drawX),ty(drawY));
        }
        cx.stroke();

        if(frac>=1){
            // Label for log
            cx.font='12px Georgia'; cx.fillStyle='#fbbf24';
            cx.textAlign='left'; cx.textBaseline='top';
            const lLabelX=5;
            const lLabelY=Math.log(lLabelX)/Math.log(logBase);
            if(lLabelY>yMin&&lLabelY<yMax){
                const lbl = logBaseName==='e'?'y = ln(x)':'y = log_'+logBaseName+'(x)';
                cx.fillText(lbl, tx(lLabelX)+4, ty(lLabelY)+6);
            }
        }
    }

    // Key points
    // (0,1) on exponential
    cx.fillStyle='#60a5fa';
    cx.beginPath();cx.arc(tx(0),ty(1),4,0,Math.PI*2);cx.fill();
    // (1,0) on log
    if(frac>=1){
        cx.fillStyle='#fbbf24';
        cx.beginPath();cx.arc(tx(1),ty(0),4,0,Math.PI*2);cx.fill();
    }
    // (b,1) on log and (1,b) on exponential
    if(frac>=1&&logBase<xMax&&logBase>0){
        cx.fillStyle='#fbbf24'; cx.globalAlpha=0.7;
        cx.beginPath();cx.arc(tx(logBase),ty(1),3,0,Math.PI*2);cx.fill();
        cx.fillStyle='#60a5fa';
        cx.beginPath();cx.arc(tx(1),ty(logBase),3,0,Math.PI*2);cx.fill();
        cx.globalAlpha=1;
        // Dashed reflection lines
        cx.setLineDash([2,3]);
        cx.strokeStyle='rgba(255,255,255,0.12)'; cx.lineWidth=1;
        cx.beginPath();cx.moveTo(tx(1),ty(logBase));cx.lineTo(tx(logBase),ty(1));cx.stroke();
        cx.setLineDash([]);
    }
}

// Click on canvas to show reflected point
logCvs.addEventListener('click', function(ev){
    const rect=logCvs.getBoundingClientRect();
    const mx=(ev.clientX-rect.left)*(logW/rect.width);
    const my=(ev.clientY-rect.top)*(logH/rect.height);
    const xMin=-3, xMax=8, yMin=-3, yMax=8;
    const cx_val=xMin+(xMax-xMin)*mx/logW;
    const cy_val=yMax-(yMax-yMin)*my/logH;

    // Check if near exponential curve
    const expY=Math.pow(logBase,cx_val);
    const screenExpY=logH-(expY-yMin)/(yMax-yMin)*logH;
    if(Math.abs(my-screenExpY)<15 && expY>yMin && expY<yMax){
        // Clicked on exponential: show reflected point on log curve
        const info=document.getElementById('logClickInfo');
        const reflX=expY, reflY=cx_val;
        info.innerHTML='<span class="blue">Exponential: ('+cx_val.toFixed(2)+', '+expY.toFixed(2)+')</span> &rarr; <span class="gold">Log: ('+reflX.toFixed(2)+', '+reflY.toFixed(2)+')</span> <span class="muted">(reflected across y = x)</span>';
        // Redraw with highlighted points
        drawLog(1);
        const lctx=logCtx;
        function txL(x){return (x-(-3))/(8-(-3))*logW;}
        function tyL(y){return logH - (y-(-3))/(8-(-3))*logH;}
        // Highlight point on exponential
        lctx.fillStyle='#60a5fa';
        lctx.beginPath();lctx.arc(txL(cx_val),tyL(expY),6,0,Math.PI*2);lctx.fill();
        // Highlight reflected point on log
        lctx.fillStyle='#fbbf24';
        lctx.beginPath();lctx.arc(txL(reflX),tyL(reflY),6,0,Math.PI*2);lctx.fill();
        // Connecting dashed line through y=x
        lctx.setLineDash([3,3]);
        lctx.strokeStyle='rgba(255,255,255,0.2)'; lctx.lineWidth=1;
        lctx.beginPath();lctx.moveTo(txL(cx_val),tyL(expY));lctx.lineTo(txL(reflX),tyL(reflY));lctx.stroke();
        lctx.setLineDash([]);
    }
});

// Reflect animation
document.getElementById('reflectBtn').addEventListener('click', function(){
    if(reflectAnim) return;
    reflectAnim=true;
    const status=document.getElementById('reflectStatus');
    status.textContent='Animating reflection...';
    const duration=1200;
    const t0=performance.now();
    function step(now){
        let frac=(now-t0)/duration;
        if(frac>=1){frac=1;reflectAnim=null;status.textContent='Reflection complete';}
        drawLog(frac);
        if(frac<1) requestAnimationFrame(step);
    }
    drawLog(0);
    requestAnimationFrame(step);
});

drawLog(1);


/* ════════════════════════════════════════════════════════════════
   Section 3: Log Laws Interactive Verifier
   ════════════════════════════════════════════════════════════════ */
function updateProductRule(){
    const x=parseFloat(document.getElementById('prodX').value);
    const y=parseFloat(document.getElementById('prodY').value);
    document.getElementById('prodXLabel').textContent=x.toFixed(1);
    document.getElementById('prodYLabel').textContent=y.toFixed(1);
    const lhs=Math.log(x*y);
    const rhs=Math.log(x)+Math.log(y);
    document.getElementById('prodResult').innerHTML=
        'ln('+x.toFixed(1)+' &times; '+y.toFixed(1)+') = ln('+( x*y).toFixed(2)+') = <span class="eq">'+lhs.toFixed(6)+'</span><br>'+
        'ln('+x.toFixed(1)+') + ln('+y.toFixed(1)+') = '+Math.log(x).toFixed(6)+' + '+Math.log(y).toFixed(6)+' = <span class="eq">'+rhs.toFixed(6)+'</span><br>'+
        '<span style="color:#808098">Difference: '+(Math.abs(lhs-rhs)).toExponential(2)+' (floating-point precision)</span>';
}

function updateQuotientRule(){
    const x=parseFloat(document.getElementById('quotX').value);
    const y=parseFloat(document.getElementById('quotY').value);
    document.getElementById('quotXLabel').textContent=x.toFixed(1);
    document.getElementById('quotYLabel').textContent=y.toFixed(1);
    const lhs=Math.log(x/y);
    const rhs=Math.log(x)-Math.log(y);
    document.getElementById('quotResult').innerHTML=
        'ln('+x.toFixed(1)+' / '+y.toFixed(1)+') = ln('+(x/y).toFixed(4)+') = <span class="eq">'+lhs.toFixed(6)+'</span><br>'+
        'ln('+x.toFixed(1)+') - ln('+y.toFixed(1)+') = '+Math.log(x).toFixed(6)+' - '+Math.log(y).toFixed(6)+' = <span class="eq">'+rhs.toFixed(6)+'</span><br>'+
        '<span style="color:#808098">Difference: '+(Math.abs(lhs-rhs)).toExponential(2)+'</span>';
}

function updatePowerRule(){
    const x=parseFloat(document.getElementById('powX').value);
    const n=parseFloat(document.getElementById('powN').value);
    document.getElementById('powXLabel').textContent=x.toFixed(1);
    document.getElementById('powNLabel').textContent=n.toFixed(1);
    const xn=Math.pow(x,n);
    const lhs=Math.log(xn);
    const rhs=n*Math.log(x);
    document.getElementById('powResult').innerHTML=
        'ln('+x.toFixed(1)+'^'+n.toFixed(1)+') = ln('+xn.toFixed(4)+') = <span class="eq">'+lhs.toFixed(6)+'</span><br>'+
        n.toFixed(1)+' &times; ln('+x.toFixed(1)+') = '+n.toFixed(1)+' &times; '+Math.log(x).toFixed(6)+' = <span class="eq">'+rhs.toFixed(6)+'</span><br>'+
        '<span style="color:#808098">Difference: '+(Math.abs(lhs-rhs)).toExponential(2)+'</span>';
}

let cobFromBase=2, cobViaBase=E;

function updateChangeOfBase(){
    const x=parseFloat(document.getElementById('cobX').value);
    document.getElementById('cobXLabel').textContent=x.toFixed(1);
    const fromVal = cobFromBase==='e'?E:cobFromBase;
    const viaVal = cobViaBase==='e'?E:cobViaBase;
    const fromName = cobFromBase==='e'?'e':cobFromBase;
    const viaName = cobViaBase==='e'?'e':cobViaBase;
    const direct = Math.log(x)/Math.log(fromVal);
    const viaNum = Math.log(x)/Math.log(viaVal);
    const viaDen = Math.log(fromVal)/Math.log(viaVal);
    const viaResult = viaNum/viaDen;
    const logSymFrom = fromName==='e'?'ln':('log_'+fromName);
    const logSymVia = viaName==='e'?'ln':('log_'+viaName);
    document.getElementById('cobResult').innerHTML=
        logSymFrom+'('+x.toFixed(1)+') = <span class="eq">'+direct.toFixed(6)+'</span><br>'+
        logSymVia+'('+x.toFixed(1)+') / '+logSymVia+'('+fromName+') = '+viaNum.toFixed(6)+' / '+viaDen.toFixed(6)+' = <span class="eq">'+viaResult.toFixed(6)+'</span><br>'+
        '<span style="color:#808098">Verified: both methods give the same result</span>';
}

// Change of base button handlers
document.querySelectorAll('[data-cob-from]').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('[data-cob-from]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v=btn.dataset.cobFrom;
        cobFromBase = v==='e'?'e':parseFloat(v);
        updateChangeOfBase();
    });
});
document.querySelectorAll('[data-cob-via]').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('[data-cob-via]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v=btn.dataset.cobVia;
        cobViaBase = v==='e'?'e':parseFloat(v);
        updateChangeOfBase();
    });
});

document.getElementById('prodX').addEventListener('input',updateProductRule);
document.getElementById('prodY').addEventListener('input',updateProductRule);
document.getElementById('quotX').addEventListener('input',updateQuotientRule);
document.getElementById('quotY').addEventListener('input',updateQuotientRule);
document.getElementById('powX').addEventListener('input',updatePowerRule);
document.getElementById('powN').addEventListener('input',updatePowerRule);
document.getElementById('cobX').addEventListener('input',updateChangeOfBase);

updateProductRule();
updateQuotientRule();
updatePowerRule();
updateChangeOfBase();


/* ════════════════════════════════════════════════════════════════
   Section 4: Log Scales
   ════════════════════════════════════════════════════════════════ */
const linCvs=document.getElementById('linearCanvas'), linCtx=linCvs.getContext('2d');
const logSCvs=document.getElementById('logScaleCanvas'), logSCtx=logSCvs.getContext('2d');
const growthSlider=document.getElementById('growthSlider');
const growthLabel=document.getElementById('growthLabel');

function drawScales(){
    const rate=parseFloat(growthSlider.value);
    growthLabel.textContent=rate.toFixed(2);

    const pad={l:50,r:20,t:30,b:40};

    // Linear scale
    {
        const cx=linCtx, w=linCvs.width, h=linCvs.height;
        cx.clearRect(0,0,w,h);cx.fillStyle='#0a0a1a';cx.fillRect(0,0,w,h);

        const xMax=10;
        const yMax=Math.pow(rate,xMax);
        const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b;

        function tx(x){return pad.l+x/xMax*plotW;}
        function ty(y){return pad.t+plotH-y/yMax*plotH;}

        // Title
        cx.font='12px Georgia'; cx.fillStyle='#808098';
        cx.textAlign='center'; cx.textBaseline='top';
        cx.fillText('Linear Scale', w/2, 6);

        // Axes
        cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
        cx.beginPath();cx.moveTo(pad.l,pad.t);cx.lineTo(pad.l,pad.t+plotH);cx.lineTo(pad.l+plotW,pad.t+plotH);cx.stroke();

        // X ticks
        cx.font='9px Georgia'; cx.fillStyle='#505068';
        cx.textAlign='center'; cx.textBaseline='top';
        for(let i=0;i<=xMax;i+=2){
            cx.fillText(i, tx(i), pad.t+plotH+6);
            cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
            cx.beginPath();cx.moveTo(tx(i),pad.t);cx.lineTo(tx(i),pad.t+plotH);cx.stroke();
        }
        cx.fillText('x (hours)', w/2, h-8);

        // Y ticks
        cx.textAlign='right'; cx.textBaseline='middle';
        const yStep=yMax>100?Math.pow(10,Math.floor(Math.log10(yMax))):yMax>10?Math.round(yMax/5):Math.round(yMax/4*10)/10;
        if(yStep>0){
            for(let yv=0;yv<=yMax;yv+=yStep){
                cx.fillText(yv>=1000?yv.toExponential(0):Math.round(yv), pad.l-6, ty(yv));
                cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
                cx.beginPath();cx.moveTo(pad.l,ty(yv));cx.lineTo(pad.l+plotW,ty(yv));cx.stroke();
            }
        }

        // Curve
        cx.strokeStyle='#60a5fa'; cx.lineWidth=2;
        cx.beginPath();
        for(let px=0;px<=plotW;px+=2){
            const x=px/plotW*xMax;
            const y=Math.pow(rate,x);
            if(px===0) cx.moveTo(tx(x),ty(y));
            else cx.lineTo(tx(x),ty(y));
        }
        cx.stroke();

        // Data points (bacterial population every hour)
        cx.fillStyle='#60a5fa';
        for(let i=0;i<=xMax;i++){
            const y=Math.pow(rate,i);
            cx.beginPath();cx.arc(tx(i),ty(y),3,0,Math.PI*2);cx.fill();
        }
    }

    // Log scale
    {
        const cx=logSCtx, w=logSCvs.width, h=logSCvs.height;
        cx.clearRect(0,0,w,h);cx.fillStyle='#0a0a1a';cx.fillRect(0,0,w,h);

        const xMax=10;
        const yMaxLog=Math.log10(Math.pow(rate,xMax));
        const yMinLog=0;
        const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b;

        function tx(x){return pad.l+x/xMax*plotW;}
        function tyLog(logY){return pad.t+plotH-(logY-yMinLog)/(yMaxLog-yMinLog)*plotH;}

        // Title
        cx.font='12px Georgia'; cx.fillStyle='#808098';
        cx.textAlign='center'; cx.textBaseline='top';
        cx.fillText('Logarithmic (y) Scale', w/2, 6);

        // Axes
        cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
        cx.beginPath();cx.moveTo(pad.l,pad.t);cx.lineTo(pad.l,pad.t+plotH);cx.lineTo(pad.l+plotW,pad.t+plotH);cx.stroke();

        // X ticks
        cx.font='9px Georgia'; cx.fillStyle='#505068';
        cx.textAlign='center'; cx.textBaseline='top';
        for(let i=0;i<=xMax;i+=2){
            cx.fillText(i, tx(i), pad.t+plotH+6);
            cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
            cx.beginPath();cx.moveTo(tx(i),pad.t);cx.lineTo(tx(i),pad.t+plotH);cx.stroke();
        }
        cx.fillText('x (hours)', w/2, h-8);

        // Y ticks (powers of 10)
        cx.textAlign='right'; cx.textBaseline='middle';
        const maxPow=Math.ceil(yMaxLog);
        for(let p=0;p<=maxPow;p++){
            if(p>yMaxLog) break;
            const label = p===0?'1':('10^'+p);
            cx.fillStyle='#505068';
            cx.fillText(label, pad.l-6, tyLog(p));
            cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
            cx.beginPath();cx.moveTo(pad.l,tyLog(p));cx.lineTo(pad.l+plotW,tyLog(p));cx.stroke();
        }

        // Curve (straight line on log scale!)
        cx.strokeStyle='#60a5fa'; cx.lineWidth=2;
        cx.beginPath();
        for(let px=0;px<=plotW;px+=2){
            const x=px/plotW*xMax;
            const logY=x*Math.log10(rate);
            if(px===0) cx.moveTo(tx(x),tyLog(logY));
            else cx.lineTo(tx(x),tyLog(logY));
        }
        cx.stroke();

        // Data points
        cx.fillStyle='#60a5fa';
        for(let i=0;i<=xMax;i++){
            const logY=i*Math.log10(rate);
            cx.beginPath();cx.arc(tx(i),tyLog(logY),3,0,Math.PI*2);cx.fill();
        }

        // Slope annotation
        cx.font='11px Georgia'; cx.fillStyle='#2ecc71';
        cx.textAlign='left'; cx.textBaseline='bottom';
        cx.fillText('slope = log('+rate.toFixed(2)+') = '+Math.log10(rate).toFixed(3), pad.l+10, pad.t+20);
        cx.fillStyle='rgba(255,255,255,0.15)';
        cx.fillText('Straight line = constant growth rate', pad.l+10, pad.t+36);
    }
}

growthSlider.addEventListener('input', drawScales);
drawScales();


/* ════════════════════════════════════════════════════════════════
   Section 5: Compound Interest & e
   ════════════════════════════════════════════════════════════════ */
const compCvs=document.getElementById('compoundCanvas'), compCtx=compCvs.getContext('2d');
const compW=compCvs.width, compH=compCvs.height;
const compSlider=document.getElementById('compoundN');
const compLabel=document.getElementById('compoundNLabel');
const compName=document.getElementById('compoundNName');

const compFreqs=[
    {n:1,     name:'annual'},
    {n:2,     name:'semi-annual'},
    {n:4,     name:'quarterly'},
    {n:12,    name:'monthly'},
    {n:365,   name:'daily'},
    {n:8760,  name:'hourly'},
    {n:Infinity, name:'continuous'}
];

function drawCompound(){
    const idx=parseInt(compSlider.value);
    const freq=compFreqs[idx];
    compLabel.textContent=freq.n===Infinity?'\u221E':freq.n;
    compName.textContent='('+freq.name+')';

    const cx=compCtx;
    cx.clearRect(0,0,compW,compH);cx.fillStyle='#0a0a1a';cx.fillRect(0,0,compW,compH);

    const pad={l:60,r:30,t:30,b:50};
    const plotW=compW-pad.l-pad.r, plotH=compH-pad.t-pad.b;
    const barCount=compFreqs.length;
    const barW=plotW/barCount*0.65;
    const gap=plotW/barCount;

    // Compute all values
    const vals=compFreqs.map(f=>{
        if(f.n===Infinity) return E;
        return Math.pow(1+1/f.n, f.n);
    });
    const yMax=3;

    function ty(y){return pad.t+plotH-y/yMax*plotH;}

    // Title
    cx.font='12px Georgia'; cx.fillStyle='#808098';
    cx.textAlign='center'; cx.textBaseline='top';
    cx.fillText('A = (1 + 1/n)^n as n increases', compW/2, 6);

    // Y axis
    cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
    cx.beginPath();cx.moveTo(pad.l,pad.t);cx.lineTo(pad.l,pad.t+plotH);cx.lineTo(pad.l+plotW,pad.t+plotH);cx.stroke();

    // Y ticks
    cx.font='10px Georgia'; cx.fillStyle='#505068';
    cx.textAlign='right'; cx.textBaseline='middle';
    for(let yv=0;yv<=yMax;yv+=0.5){
        cx.fillText(yv.toFixed(1), pad.l-8, ty(yv));
        if(yv>0){
            cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
            cx.beginPath();cx.moveTo(pad.l,ty(yv));cx.lineTo(pad.l+plotW,ty(yv));cx.stroke();
        }
    }

    // e dashed line
    cx.setLineDash([4,4]);
    cx.strokeStyle='rgba(46,204,113,0.5)'; cx.lineWidth=1.5;
    cx.beginPath();cx.moveTo(pad.l,ty(E));cx.lineTo(pad.l+plotW,ty(E));cx.stroke();
    cx.setLineDash([]);
    cx.font='11px Georgia'; cx.fillStyle='#2ecc71';
    cx.textAlign='left'; cx.textBaseline='bottom';
    cx.fillText('e = '+E.toFixed(6), pad.l+plotW-120, ty(E)-4);

    // Bars
    for(let i=0;i<barCount;i++){
        const x=pad.l+i*gap+gap/2-barW/2;
        const barH=vals[i]/yMax*plotH;
        const isActive=i<=idx;
        const isCurrent=i===idx;

        cx.fillStyle=isCurrent?'rgba(96,165,250,0.5)':isActive?'rgba(96,165,250,0.2)':'rgba(255,255,255,0.04)';
        cx.strokeStyle=isCurrent?'#60a5fa':isActive?'rgba(96,165,250,0.4)':'rgba(255,255,255,0.06)';
        cx.lineWidth=1;
        cx.fillRect(x, pad.t+plotH-barH, barW, barH);
        cx.strokeRect(x, pad.t+plotH-barH, barW, barH);

        // Value on top
        if(isActive){
            cx.font='9px Courier New'; cx.fillStyle=isCurrent?'#60a5fa':'#808098';
            cx.textAlign='center'; cx.textBaseline='bottom';
            cx.fillText(vals[i].toFixed(4), x+barW/2, pad.t+plotH-barH-4);
        }

        // Label below
        cx.font='9px Georgia'; cx.fillStyle='#606078';
        cx.textAlign='center'; cx.textBaseline='top';
        const nLabel=compFreqs[i].n===Infinity?'\u221E':compFreqs[i].n;
        cx.fillText('n='+nLabel, x+barW/2, pad.t+plotH+6);
        cx.font='8px Georgia';
        cx.fillText(compFreqs[i].name, x+barW/2, pad.t+plotH+20);
    }

    // Result text
    const result=document.getElementById('compoundResult');
    const v=vals[idx];
    if(freq.n===Infinity){
        result.innerHTML='<span class="blue">A = e = '+E.toFixed(6)+'</span> <span class="muted">&ensp;(continuous compounding: the limit as n &rarr; &infin;)</span>';
    } else {
        result.innerHTML='<span class="blue">A = (1 + 1/'+freq.n+')^'+freq.n+' = '+v.toFixed(6)+'</span> <span class="muted">&ensp;(distance from e: '+(E-v).toFixed(6)+')</span>';
    }
}

compSlider.addEventListener('input', drawCompound);
drawCompound();

// General compound interest calculator
const calcP=document.getElementById('calcP');
const calcR=document.getElementById('calcR');
const calcT=document.getElementById('calcT');
const calcFreqSlider=document.getElementById('calcFreq');
const calcPLabel=document.getElementById('calcPLabel');
const calcRLabel=document.getElementById('calcRLabel');
const calcTLabel=document.getElementById('calcTLabel');
const calcFreqLabel=document.getElementById('calcFreqLabel');
const growthCvs=document.getElementById('growthCurveCanvas'), growthCtx=growthCvs.getContext('2d');

const calcFreqs=[
    {n:1, name:'annual'},
    {n:2, name:'semi-annual'},
    {n:4, name:'quarterly'},
    {n:12, name:'monthly'},
    {n:365, name:'daily'},
    {n:Infinity, name:'continuous'}
];

function drawGrowthCurve(){
    const P=parseFloat(calcP.value);
    const r=parseFloat(calcR.value)/100;
    const t=parseInt(calcT.value);
    const fIdx=parseInt(calcFreqSlider.value);
    const freq=calcFreqs[fIdx];

    calcPLabel.textContent=P;
    calcRLabel.textContent=(r*100).toFixed(1)+'%';
    calcTLabel.textContent=t+' yr';
    calcFreqLabel.textContent=freq.name;

    // Compute final amount
    let A;
    if(freq.n===Infinity){
        A=P*Math.exp(r*t);
    } else {
        A=P*Math.pow(1+r/freq.n, freq.n*t);
    }

    // Also compute continuous for comparison
    const Acont=P*Math.exp(r*t);

    const cx=growthCtx, w=growthCvs.width, h=growthCvs.height;
    cx.clearRect(0,0,w,h);cx.fillStyle='#0a0a1a';cx.fillRect(0,0,w,h);

    const pad={l:65,r:20,t:20,b:40};
    const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b;

    const yMax=Math.max(Acont*1.15, P*1.5);

    function tx(x){return pad.l+x/t*plotW;}
    function ty(y){return pad.t+plotH-y/yMax*plotH;}

    // Axes
    cx.strokeStyle='rgba(255,255,255,0.18)'; cx.lineWidth=1.5;
    cx.beginPath();cx.moveTo(pad.l,pad.t);cx.lineTo(pad.l,pad.t+plotH);cx.lineTo(pad.l+plotW,pad.t+plotH);cx.stroke();

    // Grid + ticks
    cx.font='9px Georgia'; cx.fillStyle='#505068';
    cx.textAlign='center'; cx.textBaseline='top';
    const xStep=t<=5?1:t<=15?2:5;
    for(let yr=0;yr<=t;yr+=xStep){
        cx.fillText(yr, tx(yr), pad.t+plotH+6);
        cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
        cx.beginPath();cx.moveTo(tx(yr),pad.t);cx.lineTo(tx(yr),pad.t+plotH);cx.stroke();
    }
    cx.fillText('years', w/2, h-8);

    cx.textAlign='right'; cx.textBaseline='middle';
    const yStep=yMax>10000?Math.pow(10,Math.floor(Math.log10(yMax))):yMax>1000?Math.round(yMax/5/100)*100:Math.round(yMax/5/10)*10;
    if(yStep>0){
        for(let yv=0;yv<=yMax;yv+=yStep){
            const label=yv>=10000?(yv/1000).toFixed(0)+'k':yv>=1000?(yv/1000).toFixed(1)+'k':Math.round(yv);
            cx.fillText(label, pad.l-6, ty(yv));
            cx.strokeStyle='rgba(255,255,255,0.04)'; cx.lineWidth=1;
            cx.beginPath();cx.moveTo(pad.l,ty(yv));cx.lineTo(pad.l+plotW,ty(yv));cx.stroke();
        }
    }

    // Principal line
    cx.setLineDash([3,3]);
    cx.strokeStyle='rgba(255,255,255,0.12)'; cx.lineWidth=1;
    cx.beginPath();cx.moveTo(pad.l,ty(P));cx.lineTo(pad.l+plotW,ty(P));cx.stroke();
    cx.setLineDash([]);
    cx.font='9px Georgia'; cx.fillStyle='#606078';
    cx.textAlign='left'; cx.textBaseline='bottom';
    cx.fillText('P = '+P, pad.l+4, ty(P)-3);

    // Continuous curve (faded reference)
    if(freq.n!==Infinity){
        cx.strokeStyle='rgba(46,204,113,0.25)'; cx.lineWidth=1.5;
        cx.setLineDash([3,3]);
        cx.beginPath();
        for(let px=0;px<=plotW;px+=2){
            const yr=px/plotW*t;
            const y=P*Math.exp(r*yr);
            if(px===0) cx.moveTo(tx(yr),ty(y));
            else cx.lineTo(tx(yr),ty(y));
        }
        cx.stroke();
        cx.setLineDash([]);
    }

    // Main curve
    cx.strokeStyle='#60a5fa'; cx.lineWidth=2.5;
    cx.beginPath();
    for(let px=0;px<=plotW;px+=2){
        const yr=px/plotW*t;
        let y;
        if(freq.n===Infinity) y=P*Math.exp(r*yr);
        else y=P*Math.pow(1+r/freq.n, freq.n*yr);
        if(px===0) cx.moveTo(tx(yr),ty(y));
        else cx.lineTo(tx(yr),ty(y));
    }
    cx.stroke();

    // Final point
    cx.fillStyle='#60a5fa';
    cx.beginPath();cx.arc(tx(t),ty(A),5,0,Math.PI*2);cx.fill();
    cx.font='11px Courier New'; cx.fillStyle='#60a5fa';
    cx.textAlign='right'; cx.textBaseline='bottom';
    cx.fillText(A>=10000?'$'+(A/1000).toFixed(1)+'k':'$'+A.toFixed(2), tx(t)-8, ty(A)-8);

    // Result text
    const calcResult=document.getElementById('calcResult');
    const formula=freq.n===Infinity?
        'A = '+P+' &times; e^('+r.toFixed(3)+' &times; '+t+') = <span class="blue">$'+A.toFixed(2)+'</span>':
        'A = '+P+' &times; (1 + '+r.toFixed(3)+'/'+freq.n+')^('+freq.n+'&times;'+t+') = <span class="blue">$'+A.toFixed(2)+'</span>';
    calcResult.innerHTML=formula;

    // Rule of 72
    const rule72=document.getElementById('rule72');
    const doubleTime=Math.log(2)/Math.log(1+r);
    const rule72est=72/(r*100);
    const actualDouble=freq.n===Infinity?Math.log(2)/r:Math.log(2)/Math.log(1+r/freq.n)*1/freq.n;
    rule72.innerHTML='<span class="muted">Rule of 72: doubling time &asymp; 72 / '+(r*100).toFixed(1)+' = '+rule72est.toFixed(1)+' years</span> <span class="muted">&ensp;|&ensp;Actual: '+actualDouble.toFixed(2)+' years</span>';
}

calcP.addEventListener('input', drawGrowthCurve);
calcR.addEventListener('input', drawGrowthCurve);
calcT.addEventListener('input', drawGrowthCurve);
calcFreqSlider.addEventListener('input', drawGrowthCurve);
drawGrowthCurve();


/* ════════════════════════════════════════════════════════════════
   Touch support for all sliders
   ════════════════════════════════════════════════════════════════ */
document.querySelectorAll('input[type=range]').forEach(slider=>{
    slider.addEventListener('touchstart',function(e){e.stopPropagation();},{passive:true});
    slider.addEventListener('touchmove',function(e){e.stopPropagation();},{passive:true});
});
</script>
<footer style="text-align:center;padding:28px 20px 18px;color:#505068;font-size:0.72em;line-height:1.7;border-top:1px solid rgba(255,255,255,0.04);margin-top:30px"><div>&copy; 2025&ndash;2026 Manoj Bhaskar &middot; Coded by <a href="https://claude.ai/claude-code" style="color:#606078;text-decoration:none" target="_blank" rel="noopener">Claude</a> &middot; <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:#606078;text-decoration:none" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div></footer>
</body>
</html>
