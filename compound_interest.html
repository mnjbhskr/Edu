<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compound Interest &amp; Time Value of Money</title>
    <meta name="description" content="Visualise compound interest and the time value of money. Interactive calculators for growth, discounting, and annuities.">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LearningResource",
      "name": "Compound Interest & Time Value of Money",
      "url": "https://mathsedu.org/compound_interest.html",
      "description": "Visualise compound interest and the time value of money. Interactive calculators for growth, discounting, and annuities.",
      "educationalLevel": "Beginner",
      "teaches": "Compound interest and time value of money",
      "learningResourceType": "Interactive visualisation",
      "interactivityType": "active",
      "inLanguage": "en",
      "isAccessibleForFree": true,
      "creator": {
        "@type": "Person",
        "name": "Manoj Bhaskar"
      },
      "license": "https://creativecommons.org/licenses/by-nc-sa/4.0/",
      "isPartOf": {
        "@type": "Course",
        "name": "Quantitative Finance",
        "url": "https://mathsedu.org/"
      }
    }
    </script>
    <meta property="og:title" content="Compound Interest & Time Value of Money">
    <meta property="og:description" content="Visualise compound interest and the time value of money. Interactive calculators for growth, discounting, and annuities.">
    <meta property="og:url" content="https://mathsedu.org/compound_interest.html">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="A Visual Discovery of Mathematics">
    <meta property="og:locale" content="en_GB">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Compound Interest & Time Value of Money">
    <meta name="twitter:description" content="Visualise compound interest and the time value of money. Interactive calculators for growth, discounting, and annuities.">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#0a0a1a;color:#e0e0e0;font-family:Georgia,'Times New Roman',serif;line-height:1.6}
        .container{max-width:960px;margin:0 auto;padding:24px 28px 48px}
        .back{color:#606078;text-decoration:none;font-size:0.85em}
        .back:hover{color:#10b981}
        h1{font-size:1.8em;font-weight:400;color:#fff;margin:16px 0 4px}
        .subtitle{color:#808098;font-style:italic;margin-bottom:28px}
        h2{font-size:1.15em;font-weight:400;color:#fff;margin:28px 0 12px}
        canvas{display:block;border-radius:10px;border:1px solid rgba(255,255,255,0.06)}
        .panel{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:18px 22px;margin-bottom:20px}
        .panel h3{font-weight:400;font-size:0.8em;color:#808098;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
        .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
        .btn{background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.07);color:#b0b0c4;padding:5px 13px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:0.92em;transition:all 0.2s}
        .btn:hover{background:rgba(255,255,255,0.07);color:#e0e0ef}
        .btn.active{background:rgba(16,185,129,0.13);border-color:rgba(16,185,129,0.4);color:#10b981}
        .math-line{font-family:'Courier New',monospace;font-size:0.92em;color:#c0c0d8;margin:4px 0;line-height:1.8}
        .math-line .green{color:#10b981}.math-line .cyan{color:#22d3ee}.math-line .gold{color:#fbbf24}.math-line .gray{color:#808098}
        .math-line .muted{color:#808098}
        .slider-row{display:flex;align-items:center;gap:14px;margin:10px 0}
        .slider-row label{color:#a0a0b8;font-size:0.9em;min-width:130px}
        .slider-row input[type=range]{flex:1;max-width:300px;accent-color:#10b981;cursor:pointer}
        .slider-val{color:#10b981;font-family:'Courier New',monospace;font-size:1.05em;min-width:60px;text-align:right}
        .result-box{background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:8px;padding:14px 18px;margin:14px 0}
        .result-big{font-size:1.5em;color:#10b981;font-family:'Courier New',monospace;font-weight:bold}
        .explain{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:20px 24px;margin-top:20px}
        .explain-name{color:#10b981;font-size:1.1em;margin-bottom:6px}
        .explain-text{color:#a0a0b8;font-size:0.9em;line-height:1.75}
        .formula-block{margin:8px 0;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:6px;font-family:'Courier New',monospace;font-size:0.95em;line-height:2}
        .grid-legend{display:flex;gap:16px;flex-wrap:wrap;margin:10px 0;font-size:0.85em}
        .legend-item{display:flex;align-items:center;gap:6px}
        .legend-swatch{width:12px;height:3px;border-radius:1px}
        .tbill-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:14px 0}
        .tbill-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:16px 18px}
        .tbill-card h4{font-weight:400;font-size:0.82em;color:#10b981;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px}
        .tbill-val{font-family:'Courier New',monospace;font-size:0.92em;color:#c0c0d8;margin:4px 0}
        .tbill-val .num{color:#10b981;font-weight:bold}
        .tbill-val .lbl{color:#808098}
        .insight-box{background:rgba(16,185,129,0.04);border-left:3px solid rgba(16,185,129,0.3);border-radius:0 8px 8px 0;padding:12px 16px;margin:14px 0;font-size:0.88em;color:#a0a0b8;line-height:1.7}
        @media(max-width:600px){
            canvas{width:100%!important;height:auto!important}
            .slider-row{flex-wrap:wrap}.slider-row label{min-width:100%}
            .tbill-grid{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
<div class="container">
    <a class="back" href="index.html">&larr; Back to Index</a>
    <h1>Compound Interest &amp; Time Value of Money</h1>
    <p class="subtitle">A pound today is worth more than a pound tomorrow &mdash; the foundation of all finance</p>

    <!-- ═══════════════════════════════════════════════════════════
         Section 1: The Growth of £1
         ═══════════════════════════════════════════════════════════ -->
    <h2>1. The Growth of &pound;1</h2>
    <div class="panel">
        <h3>Simple vs Compound Interest</h3>
        <canvas id="growthCanvas" width="700" height="400"></canvas>
        <div class="grid-legend" id="growthLegend">
            <div class="legend-item"><div class="legend-swatch" style="background:#fbbf24"></div><span style="color:#fbbf24">Simple interest</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#10b981"></div><span style="color:#10b981">Compound interest</span></div>
        </div>
        <div class="btn-row">
            <button class="btn active" data-mode="both" id="btnBoth">Both</button>
            <button class="btn" data-mode="simple" id="btnSimple">Simple Interest</button>
            <button class="btn" data-mode="compound" id="btnCompound">Compound Interest</button>
        </div>
        <div class="btn-row" style="margin-top:-6px">
            <button class="btn active" id="btnLinear">Linear scale</button>
            <button class="btn" id="btnLog">Log scale</button>
        </div>
        <div class="slider-row">
            <label>Annual rate:</label>
            <input type="range" id="s1Rate" min="1" max="20" value="7">
            <span class="slider-val" id="v1Rate">7%</span>
        </div>
        <div class="slider-row">
            <label>Time horizon:</label>
            <input type="range" id="s1Time" min="1" max="50" value="30">
            <span class="slider-val" id="v1Time">30 yrs</span>
        </div>
        <div class="result-box">
            <div id="growthResults" class="math-line"></div>
        </div>
        <div class="insight-box" id="growthInsight"></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         Section 2: Compounding Frequency
         ═══════════════════════════════════════════════════════════ -->
    <h2>2. Compounding Frequency</h2>
    <div class="panel">
        <h3>How Often You Compound Matters &mdash; But Less Than You Think</h3>
        <canvas id="freqCanvas" width="700" height="400"></canvas>
        <div class="grid-legend" id="freqLegend"></div>
        <div class="slider-row">
            <label>Frequency:</label>
            <input type="range" id="s2Freq" min="0" max="6" value="0" step="1">
            <span class="slider-val" id="v2Freq">Annual</span>
        </div>
        <div class="slider-row">
            <label>Annual rate:</label>
            <input type="range" id="s2Rate" min="1" max="20" value="10">
            <span class="slider-val" id="v2Rate">10%</span>
        </div>
        <div class="slider-row">
            <label>Time horizon:</label>
            <input type="range" id="s2Time" min="1" max="50" value="20">
            <span class="slider-val" id="v2Time">20 yrs</span>
        </div>
        <div class="result-box">
            <div id="freqResults" class="math-line"></div>
            <div id="earResults" class="math-line" style="margin-top:6px;font-size:0.87em"></div>
        </div>
        <div class="formula-block" id="freqFormula"></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         Section 3: Discounting — Working Backwards
         ═══════════════════════════════════════════════════════════ -->
    <h2>3. Discounting &mdash; Working Backwards</h2>
    <div class="panel">
        <h3>Click the Timeline to Place Cash Flows</h3>
        <canvas id="discountCanvas" width="700" height="450" style="cursor:crosshair"></canvas>
        <div class="grid-legend" style="margin-top:8px">
            <div class="legend-item"><div class="legend-swatch" style="background:#10b981"></div><span style="color:#10b981">Future cash flow</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#22d3ee"></div><span style="color:#22d3ee">Face value (principal)</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#fbbf24"></div><span style="color:#fbbf24">Present value today</span></div>
            <span style="color:#505068;font-size:0.82em;margin-left:8px">&mdash; assumes annual compounding</span>
        </div>
        <div class="slider-row">
            <label>Discount rate:</label>
            <input type="range" id="s3Rate" min="1" max="15" value="5">
            <span class="slider-val" id="v3Rate">5%</span>
        </div>
        <div class="btn-row" style="margin-top:10px">
            <button class="btn" id="btnClearCF">Clear All</button>
            <button class="btn" id="btnExBond">Example: 30yr Bond</button>
            <button class="btn" id="btnExSingle">Example: Single Payment</button>
            <button class="btn" id="btnIRR" style="display:none">Solve for IRR</button>
        </div>
        <div class="result-box">
            <div style="color:#a0a0b8;font-size:0.9em;margin-bottom:4px">Total present value of all cash flows:</div>
            <div class="result-big" id="pvTotal">&pound;0.00</div>
            <div id="npvEquation" style="margin-top:8px;font-family:'Courier New',monospace;font-size:0.82em;color:#808098;line-height:1.7"></div>
            <div id="irrResult" style="margin-top:6px;font-size:0.88em;color:#a0a0b8"></div>
        </div>
        <div class="insight-box">Cash flows far in the future are worth very little today, especially at high discount rates. A &pound;1,000 payment in 30 years at 10% is worth only &pound;57 today.</div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         Section 4: Real-World Application — The T-Bill
         ═══════════════════════════════════════════════════════════ -->
    <h2>4. Real-World Application: The T-Bill</h2>
    <div class="panel">
        <h3>US Treasury Bill Pricing</h3>
        <div style="color:#a0a0b8;font-size:0.88em;line-height:1.7;margin-bottom:14px">
            Treasury bills are the simplest fixed-income instrument: you pay less than face value today and receive face value at maturity. No coupons, no complexity &mdash; just pure time value of money. But two different pricing conventions exist.
        </div>
        <div class="slider-row">
            <label>Face value:</label>
            <span class="slider-val" style="min-width:auto">&pound;10,000</span>
        </div>
        <div class="slider-row">
            <label>Days to maturity:</label>
            <input type="range" id="s4Days" min="30" max="364" value="180">
            <span class="slider-val" id="v4Days">180</span>
        </div>
        <div class="slider-row">
            <label>Discount rate:</label>
            <input type="range" id="s4Rate" min="5" max="80" value="50">
            <span class="slider-val" id="v4Rate">5.0%</span>
        </div>

        <div class="tbill-grid">
            <div class="tbill-card">
                <h4>Discount Basis (Bank Discount)</h4>
                <div class="tbill-val"><span class="lbl">Formula:</span> Face &times; (1 &minus; rate &times; days/360)</div>
                <div class="tbill-val"><span class="lbl">Price:</span> <span class="num" id="tbDiscPrice">&pound;9,750.00</span></div>
                <div class="tbill-val"><span class="lbl">Discount:</span> <span id="tbDiscAmt">&pound;250.00</span></div>
                <div class="tbill-val"><span class="lbl">Annualised yield:</span> <span id="tbDiscYield">5.13%</span></div>
                <div style="margin-top:8px;font-size:0.8em;color:#606078;line-height:1.6">US Treasury convention. Uses 360-day year. Understates the actual return.</div>
            </div>
            <div class="tbill-card">
                <h4>Investment Yield (Money Market)</h4>
                <div class="tbill-val"><span class="lbl">Formula:</span> Face / (1 + yield &times; days/365)</div>
                <div class="tbill-val"><span class="lbl">Price:</span> <span class="num" id="tbInvPrice">&pound;9,758.96</span></div>
                <div class="tbill-val"><span class="lbl">Discount:</span> <span id="tbInvAmt">&pound;241.04</span></div>
                <div class="tbill-val"><span class="lbl">Annualised yield:</span> <span id="tbInvYield">5.00%</span></div>
                <div style="margin-top:8px;font-size:0.8em;color:#606078;line-height:1.6">Actual return basis. Uses 365-day year. Gives the true annualised return.</div>
            </div>
        </div>
        <div class="result-box" style="padding:10px 16px">
            <div id="tbComparison" class="math-line" style="font-size:0.88em"></div>
        </div>
        <div class="insight-box">
            <strong style="color:#e0e0e0">Why two conventions?</strong> The 360-day year is a historical artefact from when bankers computed interest by hand &mdash; 360 divides evenly by 12 months of 30 days each. The discount basis also quotes the return relative to face value (not purchase price), which understates the investor&rsquo;s actual return. Markets live with this legacy because changing conventions would require repricing every outstanding instrument.
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         Section 5: Real vs Nominal
         ═══════════════════════════════════════════════════════════ -->
    <h2>5. Real vs Nominal &mdash; What Does 10% Actually Mean?</h2>
    <div class="panel">
        <h3>Fisher Equation: (1 + r<sub>real</sub>) = (1 + r<sub>nominal</sub>) / (1 + &pi;)</h3>
        <canvas id="realCanvas" width="700" height="320"></canvas>
        <div class="grid-legend" id="realLegend">
            <div class="legend-item"><div class="legend-swatch" style="background:#10b981"></div><span style="color:#10b981">Nominal value</span></div>
            <div class="legend-item"><div class="legend-swatch" style="background:#f87171"></div><span style="color:#f87171">Real value (inflation-adjusted)</span></div>
        </div>
        <div class="slider-row">
            <label>Nominal rate:</label>
            <input type="range" id="s5Nom" min="1" max="20" value="8">
            <span class="slider-val" id="v5Nom">8%</span>
        </div>
        <div class="slider-row">
            <label>Inflation rate (&pi;):</label>
            <input type="range" id="s5Inf" min="0" max="15" value="3">
            <span class="slider-val" id="v5Inf">3%</span>
        </div>
        <div class="slider-row">
            <label>Time horizon:</label>
            <input type="range" id="s5Time" min="1" max="40" value="20">
            <span class="slider-val" id="v5Time">20 yrs</span>
        </div>
        <div class="result-box">
            <div id="realResults" class="math-line"></div>
        </div>
        <div class="insight-box" id="realInsight"></div>
        <div class="formula-block">
            <div class="math-line"><span class="muted">Fisher approximation:</span> r<sub>real</sub> &asymp; r<sub>nominal</sub> &minus; &pi; &nbsp;&nbsp;<span class="muted">(valid when &pi; is small)</span></div>
            <div class="math-line"><span class="muted">Fisher exact:</span> r<sub>real</sub> = (1 + r<sub>nominal</sub>) / (1 + &pi;) &minus; 1</div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         Section 6: Why This Matters
         ═══════════════════════════════════════════════════════════ -->
    <h2>6. Why This Matters</h2>
    <div class="explain">
        <div class="explain-name">The Foundation of Quantitative Finance</div>
        <div class="explain-text">
            Every formula in quantitative finance builds on the time value of money. The concepts on this page &mdash; compounding, discounting, and present value &mdash; are not just introductory topics to move past. They are the active machinery inside every financial model.
            <br><br>
            <strong style="color:#e0e0e0">Black-Scholes</strong> discounts the expected payoff of an option back to today using the risk-free rate. <strong style="color:#e0e0e0">Bond prices</strong> are the sum of discounted coupon payments and discounted face value. <strong style="color:#e0e0e0">The yield curve</strong> is a map of discount rates across different time horizons &mdash; and its shape tells us what markets expect about the future.
            <br><br>
            <strong style="color:#e0e0e0">The key insight:</strong> a pound today is worth more than a pound tomorrow, because today&rsquo;s pound can be invested. This simple idea &mdash; that money has a time dimension &mdash; is the reason interest rates exist, why stocks are valued by discounted cash flows, and why the entire derivatives market is built on the mathematics of discounting.
            <br><br>
            As you explore the rest of this chapter, notice how every topic returns to discounting: random walks model how prices evolve <em>forward</em> in time, but we always discount <em>backward</em> to find today&rsquo;s fair value.
        </div>
    </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════
   Compound Interest & Time Value of Money — Chapter 11
   ══════════════════════════════════════════════════════════════ */

/* ── Helpers ── */
function fmtMoney(v) {
    if (Math.abs(v) >= 1e6) return '\u00A3' + (v / 1e6).toFixed(2) + 'M';
    if (Math.abs(v) >= 1e4) return '\u00A3' + v.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return '\u00A3' + v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
function pct(v) { return (v * 100).toFixed(1) + '%'; }

/* ══════════════════════════════════════════════════════════════
   Section 1: The Growth of £1
   ══════════════════════════════════════════════════════════════ */
var growthMode = 'both';
var growthScale = 'linear'; // 'linear' | 'log'
var cvs1 = document.getElementById('growthCanvas');
var ctx1 = cvs1.getContext('2d');
var W1 = cvs1.width, H1 = cvs1.height;

var PAD1 = { left: 70, right: 30, top: 30, bottom: 50 };

function drawGrowth() {
    var r = parseInt(document.getElementById('s1Rate').value) / 100;
    var T = parseInt(document.getElementById('s1Time').value);
    document.getElementById('v1Rate').textContent = Math.round(r * 100) + '%';
    document.getElementById('v1Time').textContent = T + ' yrs';

    /* compute max values for axis scaling */
    var simpleMax = 1 + r * T;
    var compoundMax = Math.pow(1 + r, T);
    var yMax = Math.max(simpleMax, compoundMax) * 1.1;
    if (yMax < 2) yMax = 2;

    /* log-scale helpers */
    var logMin = 0, logMax = Math.log(yMax);
    function toLog(y) { return y <= 0 ? logMin : Math.log(y); }

    /* world-to-pixel */
    var plotW = W1 - PAD1.left - PAD1.right;
    var plotH = H1 - PAD1.top - PAD1.bottom;
    function tx(x) { return PAD1.left + (x / T) * plotW; }
    function ty(y) {
        if (growthScale === 'log') {
            var ly = toLog(Math.max(0.01, y));
            return PAD1.top + plotH - ((ly - logMin) / (logMax - logMin)) * plotH;
        }
        return PAD1.top + plotH - (y / yMax) * plotH;
    }

    ctx1.clearRect(0, 0, W1, H1);
    ctx1.fillStyle = '#0a0a1a';
    ctx1.fillRect(0, 0, W1, H1);

    /* scale label */
    ctx1.fillStyle = growthScale === 'log' ? '#a78bfa' : '#505068';
    ctx1.font = '10px Georgia'; ctx1.textAlign = 'left'; ctx1.textBaseline = 'top';
    ctx1.fillText(growthScale === 'log' ? 'Log scale — compound interest is a straight line' : 'Linear scale', PAD1.left + 4, PAD1.top + 4);

    /* grid */
    ctx1.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx1.lineWidth = 1;
    if (growthScale === 'log') {
        /* log grid at powers of e or nice values */
        var logTicks = [];
        for (var p = 0; p <= Math.ceil(logMax); p += 0.5) { if (p <= logMax) logTicks.push(Math.exp(p)); }
        logTicks.forEach(function(yv) {
            var py = ty(yv);
            if (py < PAD1.top || py > H1 - PAD1.bottom) return;
            ctx1.beginPath(); ctx1.moveTo(PAD1.left, py); ctx1.lineTo(W1 - PAD1.right, py); ctx1.stroke();
            ctx1.fillStyle = '#505068'; ctx1.font = '10px Georgia'; ctx1.textAlign = 'right'; ctx1.textBaseline = 'middle';
            ctx1.fillText(fmtMoney(yv), PAD1.left - 8, py);
        });
    } else {
        var yStep = niceStep(yMax, 6);
        for (var yv = 0; yv <= yMax; yv += yStep) {
            var py = ty(yv);
            ctx1.beginPath(); ctx1.moveTo(PAD1.left, py); ctx1.lineTo(W1 - PAD1.right, py); ctx1.stroke();
            ctx1.fillStyle = '#505068'; ctx1.font = '10px Georgia'; ctx1.textAlign = 'right'; ctx1.textBaseline = 'middle';
            ctx1.fillText(fmtMoney(yv), PAD1.left - 8, py);
        }
    }
    var xStep = niceStep(T, 8);
    for (var xv = 0; xv <= T; xv += xStep) {
        var px = tx(xv);
        ctx1.strokeStyle = 'rgba(255,255,255,0.04)';
        ctx1.beginPath(); ctx1.moveTo(px, PAD1.top); ctx1.lineTo(px, H1 - PAD1.bottom); ctx1.stroke();
        ctx1.fillStyle = '#505068'; ctx1.font = '10px Georgia'; ctx1.textAlign = 'center'; ctx1.textBaseline = 'top';
        ctx1.fillText(xv + 'y', px, H1 - PAD1.bottom + 8);
    }

    /* axes */
    ctx1.strokeStyle = 'rgba(255,255,255,0.18)'; ctx1.lineWidth = 1.5;
    ctx1.beginPath(); ctx1.moveTo(PAD1.left, PAD1.top); ctx1.lineTo(PAD1.left, H1 - PAD1.bottom); ctx1.lineTo(W1 - PAD1.right, H1 - PAD1.bottom); ctx1.stroke();

    /* simple interest line */
    if (growthMode === 'simple' || growthMode === 'both') {
        ctx1.strokeStyle = '#fbbf24'; ctx1.lineWidth = 2; ctx1.globalAlpha = growthMode === 'both' ? 0.8 : 1;
        ctx1.beginPath();
        for (var t = 0; t <= T; t++) {
            var sv = 1 + r * t;
            var px = tx(t), py = ty(sv);
            if (t === 0) ctx1.moveTo(px, py); else ctx1.lineTo(px, py);
        }
        ctx1.stroke(); ctx1.globalAlpha = 1;
    }

    /* compound interest curve */
    if (growthMode === 'compound' || growthMode === 'both') {
        ctx1.strokeStyle = '#10b981'; ctx1.lineWidth = 2;
        ctx1.beginPath();
        var steps = Math.max(T * 4, 100);
        for (var i = 0; i <= steps; i++) {
            var t = (i / steps) * T;
            var cv = Math.pow(1 + r, t);
            var px = tx(t), py = ty(cv);
            if (py < PAD1.top) py = PAD1.top;
            if (i === 0) ctx1.moveTo(px, py); else ctx1.lineTo(px, py);
        }
        ctx1.stroke();
    }

    /* log-scale annotation */
    if (growthScale === 'log') {
        ctx1.fillStyle = 'rgba(167,139,250,0.55)';
        ctx1.font = 'italic 9px Georgia'; ctx1.textAlign = 'left'; ctx1.textBaseline = 'top';
        if (growthMode !== 'simple') ctx1.fillText('Compound \u2192 straight line on log scale', PAD1.left + 8, PAD1.top + 18);
        if (growthMode !== 'compound') ctx1.fillText('Simple \u2192 concave curve on log scale', PAD1.left + 8, PAD1.top + 30);
    }

    /* gap annotation at endpoint (linear only) */
    if (growthScale === 'linear' && growthMode === 'both' && T > 5) {
        var endSimple = 1 + r * T;
        var endComp = Math.pow(1 + r, T);
        var gap = endComp - endSimple;
        var ys = ty(endSimple), yc = ty(endComp);
        var xEnd = tx(T) + 8;
        if (yc >= PAD1.top + 10) {
            ctx1.strokeStyle = 'rgba(16,185,129,0.4)'; ctx1.lineWidth = 1; ctx1.setLineDash([3, 3]);
            ctx1.beginPath(); ctx1.moveTo(xEnd, yc); ctx1.lineTo(xEnd, ys); ctx1.stroke();
            ctx1.setLineDash([]);
            ctx1.fillStyle = '#10b981'; ctx1.font = '10px "Courier New", monospace'; ctx1.textAlign = 'left'; ctx1.textBaseline = 'middle';
            ctx1.fillText('+' + fmtMoney(gap), xEnd + 4, (yc + ys) / 2);
        }
    }

    /* results display */
    var endS = 1 + r * T;
    var endC = Math.pow(1 + r, T);
    /* rate sensitivity: ∂FV/∂r = T·(1+r)^(T-1) */
    var dFVdr = T * Math.pow(1 + r, T - 1);
    var res = '';
    res += '<span class="gold">Simple:</span> ' + fmtMoney(endS);
    res += ' &nbsp;&nbsp; <span class="green">Compound:</span> ' + fmtMoney(endC);
    res += ' &nbsp;&nbsp; <span class="muted">Gap:</span> ' + fmtMoney(endC - endS);
    res += ' &nbsp;&nbsp; <span class="muted">&part;FV/&part;r:</span> <span style="color:#a78bfa">' + dFVdr.toFixed(1) + 'x</span>';
    document.getElementById('growthResults').innerHTML = res;

    /* insight — deepened with exponential explanation */
    var ratio = endC / endS;
    var insight = 'At ' + Math.round(r * 100) + '% over ' + T + ' years, compound interest produces ';
    insight += ratio.toFixed(1) + '&times; as much as simple interest. ';
    insight += '<strong>Compound growth is exponential because the growth rate applies to a base that itself grows</strong> &mdash; each period&rsquo;s interest earns interest in the next. ';
    if (ratio > 3) insight += 'The exponential curve dramatically outpaces linear growth &mdash; this is the power of compounding. A 1% increase in rate from here would add an extra ' + fmtMoney(dFVdr * 0.01) + ' to the final value.';
    else if (ratio > 1.5) insight += 'The compounding effect is already significant. On the <strong>log scale</strong>, compound interest becomes a straight line &mdash; confirming the exponential relationship. A 1% rate increase adds ' + fmtMoney(dFVdr * 0.01) + ' to the terminal value.';
    else insight += 'Over shorter periods, the two stay close &mdash; try increasing the time horizon to see compounding dominate. Switch to log scale to see compound interest reveal its straight-line exponential structure.';
    document.getElementById('growthInsight').innerHTML = insight;
}

/* log/linear toggle */
document.getElementById('btnLinear').addEventListener('click', function() {
    growthScale = 'linear';
    document.getElementById('btnLinear').classList.add('active');
    document.getElementById('btnLog').classList.remove('active');
    drawGrowth();
});
document.getElementById('btnLog').addEventListener('click', function() {
    growthScale = 'log';
    document.getElementById('btnLog').classList.add('active');
    document.getElementById('btnLinear').classList.remove('active');
    drawGrowth();
});

function niceStep(max, targetTicks) {
    var rough = max / targetTicks;
    var mag = Math.pow(10, Math.floor(Math.log10(rough)));
    var norm = rough / mag;
    var step;
    if (norm < 1.5) step = 1;
    else if (norm < 3) step = 2;
    else if (norm < 7) step = 5;
    else step = 10;
    return step * mag;
}

/* mode buttons */
document.querySelectorAll('[data-mode]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('[data-mode]').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        growthMode = btn.dataset.mode;
        drawGrowth();
    });
});

document.getElementById('s1Rate').addEventListener('input', drawGrowth);
document.getElementById('s1Time').addEventListener('input', drawGrowth);
[document.getElementById('s1Rate'), document.getElementById('s1Time')].forEach(function(s) {
    s.addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: true });
    s.addEventListener('touchmove', function(e) { e.stopPropagation(); }, { passive: true });
});

/* ══════════════════════════════════════════════════════════════
   Section 2: Compounding Frequency
   ══════════════════════════════════════════════════════════════ */
var FREQ_STEPS = [
    { n: 1,    label: 'Annual',      color: '#ef4444' },
    { n: 2,    label: 'Semi-annual', color: '#f97316' },
    { n: 4,    label: 'Quarterly',   color: '#fbbf24' },
    { n: 12,   label: 'Monthly',     color: '#a3e635' },
    { n: 52,   label: 'Weekly',      color: '#34d399' },
    { n: 365,  label: 'Daily',       color: '#22d3ee' },
    { n: Infinity, label: 'Continuous', color: '#10b981' }
];

var cvs2 = document.getElementById('freqCanvas');
var ctx2 = cvs2.getContext('2d');
var W2 = cvs2.width, H2 = cvs2.height;
var PAD2 = { left: 70, right: 30, top: 30, bottom: 50 };

function drawFreq() {
    var freqIdx = parseInt(document.getElementById('s2Freq').value);
    var r = parseInt(document.getElementById('s2Rate').value) / 100;
    var T = parseInt(document.getElementById('s2Time').value);
    document.getElementById('v2Freq').textContent = FREQ_STEPS[freqIdx].label;
    document.getElementById('v2Rate').textContent = Math.round(r * 100) + '%';
    document.getElementById('v2Time').textContent = T + ' yrs';

    /* y-axis max: continuous is always highest */
    var yMax = Math.exp(r * T) * 1.1;
    if (yMax < 2) yMax = 2;

    var plotW = W2 - PAD2.left - PAD2.right;
    var plotH = H2 - PAD2.top - PAD2.bottom;
    function tx(x) { return PAD2.left + (x / T) * plotW; }
    function ty(y) { return PAD2.top + plotH - (y / yMax) * plotH; }

    ctx2.clearRect(0, 0, W2, H2);
    ctx2.fillStyle = '#0a0a1a';
    ctx2.fillRect(0, 0, W2, H2);

    /* grid */
    ctx2.strokeStyle = 'rgba(255,255,255,0.04)'; ctx2.lineWidth = 1;
    var yStep = niceStep(yMax, 6);
    for (var yv = 0; yv <= yMax; yv += yStep) {
        var py = ty(yv);
        ctx2.beginPath(); ctx2.moveTo(PAD2.left, py); ctx2.lineTo(W2 - PAD2.right, py); ctx2.stroke();
        ctx2.fillStyle = '#505068'; ctx2.font = '10px Georgia'; ctx2.textAlign = 'right'; ctx2.textBaseline = 'middle';
        ctx2.fillText(fmtMoney(yv), PAD2.left - 8, py);
    }
    var xStep = niceStep(T, 8);
    for (var xv = 0; xv <= T; xv += xStep) {
        var px = tx(xv);
        ctx2.beginPath(); ctx2.moveTo(px, PAD2.top); ctx2.lineTo(px, H2 - PAD2.bottom); ctx2.stroke();
        ctx2.fillStyle = '#505068'; ctx2.font = '10px Georgia'; ctx2.textAlign = 'center'; ctx2.textBaseline = 'top';
        ctx2.fillText(xv + 'y', px, H2 - PAD2.bottom + 8);
    }

    /* axes */
    ctx2.strokeStyle = 'rgba(255,255,255,0.18)'; ctx2.lineWidth = 1.5;
    ctx2.beginPath(); ctx2.moveTo(PAD2.left, PAD2.top); ctx2.lineTo(PAD2.left, H2 - PAD2.bottom); ctx2.lineTo(W2 - PAD2.right, H2 - PAD2.bottom); ctx2.stroke();

    /* draw all curves up to selected frequency */
    var steps = Math.max(T * 4, 100);
    for (var fi = 0; fi <= freqIdx; fi++) {
        var f = FREQ_STEPS[fi];
        var isSelected = (fi === freqIdx);
        ctx2.strokeStyle = f.color;
        ctx2.lineWidth = isSelected ? 2.5 : 1.5;
        ctx2.globalAlpha = isSelected ? 1 : 0.35;
        if (f.n === Infinity) { ctx2.setLineDash([4, 3]); }
        else { ctx2.setLineDash([]); }
        ctx2.beginPath();
        for (var i = 0; i <= steps; i++) {
            var t = (i / steps) * T;
            var v;
            if (f.n === Infinity) v = Math.exp(r * t);
            else v = Math.pow(1 + r / f.n, f.n * t);
            var px = tx(t), py = ty(v);
            if (py < PAD2.top) py = PAD2.top;
            if (i === 0) ctx2.moveTo(px, py); else ctx2.lineTo(px, py);
        }
        ctx2.stroke();
        ctx2.setLineDash([]);
        ctx2.globalAlpha = 1;
    }

    /* always draw continuous as dashed reference if not already drawn */
    if (freqIdx < 6) {
        ctx2.strokeStyle = 'rgba(16,185,129,0.25)'; ctx2.lineWidth = 1; ctx2.setLineDash([4, 3]);
        ctx2.beginPath();
        for (var i = 0; i <= steps; i++) {
            var t = (i / steps) * T;
            var v = Math.exp(r * t);
            var px = tx(t), py = ty(v);
            if (py < PAD2.top) py = PAD2.top;
            if (i === 0) ctx2.moveTo(px, py); else ctx2.lineTo(px, py);
        }
        ctx2.stroke(); ctx2.setLineDash([]);
    }

    /* legend */
    var legendDiv = document.getElementById('freqLegend');
    var legendHtml = '';
    for (var fi = 0; fi <= freqIdx; fi++) {
        var f = FREQ_STEPS[fi];
        var dash = f.n === Infinity ? 'border-top:2px dashed ' + f.color + ';background:transparent' : 'background:' + f.color;
        legendHtml += '<div class="legend-item"><div class="legend-swatch" style="' + dash + '"></div><span style="color:' + f.color + '">' + f.label + '</span></div>';
    }
    if (freqIdx < 6) {
        legendHtml += '<div class="legend-item"><div class="legend-swatch" style="border-top:2px dashed rgba(16,185,129,0.4);background:transparent"></div><span style="color:rgba(16,185,129,0.4)">Continuous (limit)</span></div>';
    }
    legendDiv.innerHTML = legendHtml;

    /* result display */
    var sel = FREQ_STEPS[freqIdx];
    var selVal = sel.n === Infinity ? Math.exp(r * T) : Math.pow(1 + r / sel.n, sel.n * T);
    var contVal = Math.exp(r * T);
    /* EAR calculation */
    var ear = sel.n === Infinity ? Math.exp(r) - 1 : Math.pow(1 + r / sel.n, sel.n) - 1;
    var earMonthly = Math.pow(1 + r / 12, 12) - 1;
    var earCont = Math.exp(r) - 1;
    var res = '<span style="color:' + sel.color + '">' + sel.label + ':</span> ';
    if (sel.n === Infinity) {
        res += 'e<sup>' + (r * 100).toFixed(0) + '%&times;' + T + '</sup> = <span class="green">' + fmtMoney(selVal) + '</span>';
    } else {
        res += '(1 + ' + pct(r) + '/' + sel.n + ')<sup>' + sel.n + '&times;' + T + '</sup> = <span style="color:' + sel.color + '">' + fmtMoney(selVal) + '</span>';
    }
    res += ' &nbsp;&nbsp; <span class="muted">Continuous limit:</span> <span class="green">' + fmtMoney(contVal) + '</span>';
    if (sel.n !== Infinity) {
        var diff = contVal - selVal;
        res += ' &nbsp;&nbsp; <span class="muted">Difference:</span> ' + fmtMoney(diff);
    }
    document.getElementById('freqResults').innerHTML = res;

    /* EAR line + monthly-vs-continuous punchline */
    var earHtml = '<span class="muted">Nominal rate:</span> <span class="green">' + pct(r) + '</span>';
    earHtml += ' &nbsp;&nbsp; <span class="muted">EAR = (1 + r/n)<sup>n</sup> &minus; 1 =</span> <span style="color:' + sel.color + '">' + pct(ear) + '</span>';
    if (sel.n !== Infinity) {
        var bpsGain = (earCont - earMonthly) * 10000;
        earHtml += ' &nbsp;&nbsp; <span class="muted">Monthly&rarr;Continuous gain:</span> <span style="color:#a78bfa">' + bpsGain.toFixed(1) + ' bps</span>';
    }
    document.getElementById('earResults').innerHTML = earHtml;

    /* formula */
    var formulaHtml = '<div class="math-line"><span class="muted">General:</span> (1 + <span class="green">r</span>/<span class="cyan">n</span>)<sup><span class="cyan">n</span>&middot;<span class="gold">t</span></sup></div>';
    formulaHtml += '<div class="math-line"><span class="muted">As n &rarr; &infin;:</span> (1 + <span class="green">' + pct(r) + '</span>/<span class="cyan">n</span>)<sup><span class="cyan">n</span>&middot;<span class="gold">' + T + '</span></sup> &rarr; e<sup><span class="green">' + pct(r) + '</span>&middot;<span class="gold">' + T + '</span></sup> = <span class="green">' + fmtMoney(contVal) + '</span></div>';
    document.getElementById('freqFormula').innerHTML = formulaHtml;
}

document.getElementById('s2Freq').addEventListener('input', drawFreq);
document.getElementById('s2Rate').addEventListener('input', drawFreq);
document.getElementById('s2Time').addEventListener('input', drawFreq);
[document.getElementById('s2Freq'), document.getElementById('s2Rate'), document.getElementById('s2Time')].forEach(function(s) {
    s.addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: true });
    s.addEventListener('touchmove', function(e) { e.stopPropagation(); }, { passive: true });
});

/* ══════════════════════════════════════════════════════════════
   Section 3: Discounting — Working Backwards
   ══════════════════════════════════════════════════════════════ */
var cashFlows = [];
var cvs3 = document.getElementById('discountCanvas');
var ctx3 = cvs3.getContext('2d');
var W3 = cvs3.width, H3 = cvs3.height;
var PAD3 = { left: 55, right: 30, top: 45, bottom: 55 };
var MAX_YEAR = 30;
var CF_AMOUNT = 1000;

function drawDiscount() {
    var dr = parseInt(document.getElementById('s3Rate').value) / 100;
    document.getElementById('v3Rate').textContent = Math.round(dr * 100) + '%';

    var plotW = W3 - PAD3.left - PAD3.right;
    function tx(yr) { return PAD3.left + (yr / MAX_YEAR) * plotW; }

    ctx3.clearRect(0, 0, W3, H3);
    ctx3.fillStyle = '#0a0a1a';
    ctx3.fillRect(0, 0, W3, H3);

    /* timeline axis */
    var timelineY = H3 - PAD3.bottom - 32;
    ctx3.strokeStyle = 'rgba(255,255,255,0.18)'; ctx3.lineWidth = 1.5;
    ctx3.beginPath(); ctx3.moveTo(PAD3.left, timelineY); ctx3.lineTo(W3 - PAD3.right, timelineY); ctx3.stroke();

    /* year ticks */
    for (var yr = 0; yr <= MAX_YEAR; yr += 5) {
        var px = tx(yr);
        ctx3.strokeStyle = 'rgba(255,255,255,0.08)'; ctx3.lineWidth = 1;
        ctx3.beginPath(); ctx3.moveTo(px, timelineY - 5); ctx3.lineTo(px, timelineY + 5); ctx3.stroke();
        ctx3.fillStyle = '#606078'; ctx3.font = '11px Georgia'; ctx3.textAlign = 'center'; ctx3.textBaseline = 'top';
        ctx3.fillText('Yr ' + yr, px, timelineY + 8);
    }

    /* "Today" label */
    ctx3.fillStyle = '#10b981'; ctx3.font = '12px Georgia'; ctx3.textAlign = 'center'; ctx3.textBaseline = 'top';
    ctx3.fillText('Today', tx(0), timelineY + 24);

    /* empty state */
    if (cashFlows.length === 0) {
        ctx3.fillStyle = '#606078'; ctx3.font = '14px Georgia'; ctx3.textAlign = 'center'; ctx3.textBaseline = 'middle';
        ctx3.fillText('Click the timeline to place \u00A31,000 cash flows', W3 / 2, H3 * 0.38);
        ctx3.fillText('or try an example below', W3 / 2, H3 * 0.38 + 26);
        document.getElementById('pvTotal').textContent = fmtMoney(0);
        return;
    }

    /* sort and compute PVs */
    var sorted = cashFlows.slice().sort(function(a, b) { return a.year - b.year; });
    var maxCF = 0;
    sorted.forEach(function(cf) { if (cf.amount > maxCF) maxCF = cf.amount; });

    var maxBarH = timelineY - PAD3.top - 42;
    var barW = Math.min(16, Math.max(8, plotW / (MAX_YEAR * 1.35)));
    var pvBarW = Math.max(4, barW * 0.5);

    var totalPV = 0;
    sorted.forEach(function(cf) {
        cf._pv = cf.amount / Math.pow(1 + dr, cf.year);
        totalPV += cf._pv;
    });

    /* which bars get labels (avoid clutter) */
    var labelSet = {};
    if (sorted.length <= 6) {
        sorted.forEach(function(cf) { labelSet[cf.year] = true; });
    } else {
        labelSet[sorted[0].year] = true;
        labelSet[sorted[sorted.length - 1].year] = true;
        if (sorted.length > 12) labelSet[sorted[Math.floor(sorted.length / 3)].year] = true;
    }

    /* detect bond pattern (has face property) */
    var isBond = sorted.some(function(cf) { return cf.face > 0; });

    /* ── draw bars ── */
    sorted.forEach(function(cf) {
        var px = tx(cf.year);
        var barH = Math.max(15, (cf.amount / maxCF) * maxBarH);
        var pvH = Math.max(2, (cf._pv / maxCF) * maxBarH);

        if (cf.face) {
            /* stacked bar: coupon (green bottom) + face (cyan top) */
            var cH = Math.max(12, (cf.coupon / maxCF) * maxBarH);
            var fH = Math.max(4, (cf.face / maxCF) * maxBarH);
            /* face portion */
            ctx3.fillStyle = 'rgba(34,211,238,0.2)';
            ctx3.fillRect(px - barW / 2, timelineY - cH - fH, barW, fH);
            ctx3.strokeStyle = 'rgba(34,211,238,0.45)'; ctx3.lineWidth = 1;
            ctx3.strokeRect(px - barW / 2, timelineY - cH - fH, barW, fH);
            /* coupon portion */
            ctx3.fillStyle = 'rgba(16,185,129,0.2)';
            ctx3.fillRect(px - barW / 2, timelineY - cH, barW, cH);
            ctx3.strokeStyle = 'rgba(16,185,129,0.45)'; ctx3.lineWidth = 1;
            ctx3.strokeRect(px - barW / 2, timelineY - cH, barW, cH);
        } else {
            /* regular bar */
            ctx3.fillStyle = 'rgba(16,185,129,0.18)';
            ctx3.fillRect(px - barW / 2, timelineY - barH, barW, barH);
            ctx3.strokeStyle = 'rgba(16,185,129,0.45)'; ctx3.lineWidth = 1;
            ctx3.strokeRect(px - barW / 2, timelineY - barH, barW, barH);
        }

        /* PV bar (gold, narrower, same baseline) */
        ctx3.fillStyle = 'rgba(251,191,36,0.5)';
        ctx3.fillRect(px - pvBarW / 2, timelineY - pvH, pvBarW, pvH);
    });

    /* ── labels for selected bars ── */
    sorted.forEach(function(cf) {
        if (!labelSet[cf.year]) return;
        var px = tx(cf.year);
        var barH = Math.max(15, (cf.amount / maxCF) * maxBarH);
        ctx3.fillStyle = '#10b981'; ctx3.font = '12px "Courier New", monospace';
        ctx3.textAlign = 'center'; ctx3.textBaseline = 'bottom';
        ctx3.fillText(fmtMoney(cf.amount), px, timelineY - barH - 6);
        ctx3.fillStyle = '#fbbf24'; ctx3.font = '11px "Courier New", monospace';
        ctx3.fillText('PV ' + fmtMoney(cf._pv), px, timelineY - barH - 22);
    });

    /* ── bond annotations ── */
    if (isBond) {
        var couponAmt = sorted[0].amount;
        ctx3.fillStyle = '#808098'; ctx3.font = '11px Georgia'; ctx3.textAlign = 'left'; ctx3.textBaseline = 'middle';
        var cBarH = Math.max(15, (couponAmt / maxCF) * maxBarH);
        ctx3.fillText('\u00A3' + couponAmt + '/yr coupon', tx(3) + barW, timelineY - cBarH / 2);

        var lastCF = sorted[sorted.length - 1];
        if (lastCF.face) {
            var totalH = Math.max(15, (lastCF.amount / maxCF) * maxBarH);
            ctx3.fillStyle = '#22d3ee'; ctx3.font = '11px Georgia'; ctx3.textAlign = 'left';
            ctx3.fillText('\u00A3' + lastCF.face.toLocaleString() + ' face', tx(lastCF.year) + barW / 2 + 6, timelineY - totalH + 30);
        }
    }

    /* ── discount arrows (max 3, representative) ── */
    var arrowIdxs = [];
    if (sorted.length <= 3) {
        for (var i = 0; i < sorted.length; i++) arrowIdxs.push(i);
    } else {
        arrowIdxs = [Math.min(3, sorted.length - 1), Math.floor(sorted.length / 2), sorted.length - 1];
    }
    arrowIdxs.forEach(function(idx, ai) {
        var cf = sorted[idx];
        var px = tx(cf.year);
        var barH = Math.max(15, (cf.amount / maxCF) * maxBarH);
        var todayX = tx(0);
        var cpY = PAD3.top + 8 + ai * 18;
        ctx3.strokeStyle = 'rgba(251,191,36,0.3)'; ctx3.lineWidth = 1; ctx3.setLineDash([4, 3]);
        ctx3.beginPath();
        ctx3.moveTo(px, timelineY - barH);
        ctx3.quadraticCurveTo((px + todayX) / 2, cpY, todayX + 14, timelineY - 30);
        ctx3.stroke(); ctx3.setLineDash([]);
        ctx3.fillStyle = 'rgba(251,191,36,0.35)';
        ctx3.beginPath();
        ctx3.moveTo(todayX + 14, timelineY - 30);
        ctx3.lineTo(todayX + 20, timelineY - 35);
        ctx3.lineTo(todayX + 20, timelineY - 25);
        ctx3.closePath(); ctx3.fill();
    });

    /* ── PV total bar at year 0 ── */
    var pvTotalH = Math.min(maxBarH * 0.85, Math.max(18, (totalPV / maxCF) * maxBarH));
    var todayX = tx(0);
    ctx3.fillStyle = 'rgba(251,191,36,0.2)';
    ctx3.fillRect(todayX - barW / 2, timelineY - pvTotalH, barW, pvTotalH);
    ctx3.strokeStyle = '#fbbf24'; ctx3.lineWidth = 1.5;
    ctx3.strokeRect(todayX - barW / 2, timelineY - pvTotalH, barW, pvTotalH);
    ctx3.fillStyle = '#fbbf24'; ctx3.font = 'bold 13px "Courier New", monospace';
    ctx3.textAlign = 'right'; ctx3.textBaseline = 'middle';
    ctx3.fillText(fmtMoney(totalPV), todayX - barW / 2 - 6, timelineY - pvTotalH / 2);

    document.getElementById('pvTotal').textContent = fmtMoney(totalPV);

    /* dynamic NPV equation */
    var npvDiv = document.getElementById('npvEquation');
    var irrBtn = document.getElementById('btnIRR');
    if (sorted.length > 0 && sorted.length <= 6) {
        var eq = 'PV = ';
        eq += sorted.map(function(cf) {
            return '\u00A3' + cf.amount.toLocaleString() + '/(1+r)\u207F\u207F'.replace('nn', cf.year > 9 ? '' : '') + '<sup>' + cf.year + '</sup>';
        }).join(' + ');
        eq += ' = <strong style="color:#10b981">' + fmtMoney(totalPV) + '</strong>';
        npvDiv.innerHTML = eq;
    } else if (sorted.length > 6) {
        npvDiv.innerHTML = 'PV = &sum;<sub>t=1</sub><sup>' + sorted[sorted.length-1].year + '</sup> CF<sub>t</sub> / (1+r)<sup>t</sup> = <strong style="color:#10b981">' + fmtMoney(totalPV) + '</strong>';
    } else {
        npvDiv.innerHTML = '';
    }
    /* show IRR button only when multiple distinct cash flows exist */
    irrBtn.style.display = (sorted.length > 1) ? 'inline-block' : 'none';
}

/* IRR solver — Newton's method */
document.getElementById('btnIRR').addEventListener('click', function() {
    var sorted = cashFlows.slice().sort(function(a, b) { return a.year - b.year; });
    if (sorted.length < 2) return;
    /* seed with discount rate */
    var irr = parseInt(document.getElementById('s3Rate').value) / 100;
    var cost = sorted[0]._pv || sorted[0].amount / 2; /* approximate initial outflow as first PV */
    /* treat all inflows as positive, no initial outflow — solve for rate that gives NPV=0 */
    /* Use current PV as notional cost: NPV = -totalPV_at_0% + PV_at_irr = 0 not applicable here */
    /* Instead: IRR = rate where PV of cash flows = initial investment (face value for bonds) */
    var irrDiv = document.getElementById('irrResult');
    /* For pure inflow scenario (no outflow), IRR is not meaningful; guide user */
    var hasFace = sorted.some(function(cf) { return cf.face > 0; });
    if (hasFace) {
        /* Bond IRR = yield to maturity. Solve: PV(cashflows at irr) = face value */
        var faceVal = sorted[sorted.length - 1].face;
        var r = 0.05;
        for (var iter = 0; iter < 60; iter++) {
            var npv = -faceVal;
            var dnpv = 0;
            sorted.forEach(function(cf) {
                npv  += cf.amount / Math.pow(1 + r, cf.year);
                dnpv -= cf.year * cf.amount / Math.pow(1 + r, cf.year + 1);
            });
            if (Math.abs(npv) < 0.01) break;
            r -= npv / (dnpv || 1e-8);
            r = Math.max(0.0001, Math.min(0.99, r));
        }
        irrDiv.innerHTML = '<span style="color:#a78bfa">IRR (Yield to Maturity):</span> <strong style="color:#10b981">' + pct(r) + '</strong> &mdash; the discount rate at which PV of all cash flows equals face value (' + fmtMoney(faceVal) + ')';
    } else {
        /* Generic IRR: PV of flows at irr = sum of all flows / (1+irr)^t; no natural cost basis here */
        irrDiv.innerHTML = '<span style="color:#808098">IRR requires an initial outflow. For the bond example, use <strong>Example: 30yr Bond</strong> to see yield to maturity.</span>';
    }
});

/* click to place cash flows */
cvs3.addEventListener('click', function(e) {
    var rect = cvs3.getBoundingClientRect();
    var scaleX = W3 / rect.width;
    var mx = (e.clientX - rect.left) * scaleX;
    var plotW = W3 - PAD3.left - PAD3.right;
    var year = Math.round(((mx - PAD3.left) / plotW) * MAX_YEAR);
    if (year < 1) year = 1;
    if (year > MAX_YEAR) year = MAX_YEAR;

    /* toggle: if cash flow already at this year, remove it */
    var existing = cashFlows.findIndex(function(cf) { return cf.year === year; });
    if (existing >= 0) {
        cashFlows.splice(existing, 1);
    } else {
        cashFlows.push({ year: year, amount: CF_AMOUNT });
    }
    drawDiscount();
});

document.getElementById('s3Rate').addEventListener('input', drawDiscount);
document.getElementById('s3Rate').addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: true });
document.getElementById('s3Rate').addEventListener('touchmove', function(e) { e.stopPropagation(); }, { passive: true });

/* preset buttons */
document.getElementById('btnClearCF').addEventListener('click', function() {
    cashFlows = [];
    drawDiscount();
});
document.getElementById('btnExBond').addEventListener('click', function() {
    cashFlows = [];
    /* 30-year bond: 5% coupon on £1,000 face = £50/yr, plus £1,000 face at maturity */
    for (var y = 1; y <= 29; y++) {
        cashFlows.push({ year: y, amount: 50 });
    }
    cashFlows.push({ year: 30, amount: 1050, coupon: 50, face: 1000 });
    drawDiscount();
});
document.getElementById('btnExSingle').addEventListener('click', function() {
    cashFlows = [{ year: 20, amount: CF_AMOUNT }];
    drawDiscount();
});

/* ══════════════════════════════════════════════════════════════
   Section 4: T-Bill Pricing
   ══════════════════════════════════════════════════════════════ */
function updateTBill() {
    var face = 10000;
    var days = parseInt(document.getElementById('s4Days').value);
    /* slider range 5–80 maps to 0.5%–8.0% in 0.1% steps */
    var rate = parseInt(document.getElementById('s4Rate').value) / 10 / 100;
    document.getElementById('v4Days').textContent = days;
    document.getElementById('v4Rate').textContent = (rate * 100).toFixed(1) + '%';

    /* Discount basis: Price = Face * (1 - rate * days/360) */
    var discPrice = face * (1 - rate * days / 360);
    var discAmt = face - discPrice;
    /* Actual annualised yield from discount price: (Face - Price)/Price * 365/days */
    var discYield = (discAmt / discPrice) * (365 / days);

    /* Investment yield: Price = Face / (1 + yield * days/365) */
    var invPrice = face / (1 + rate * days / 365);
    var invAmt = face - invPrice;
    /* The yield IS the rate for this convention */
    var invYield = rate;

    document.getElementById('tbDiscPrice').textContent = fmtMoney(discPrice);
    document.getElementById('tbDiscAmt').textContent = fmtMoney(discAmt);
    document.getElementById('tbDiscYield').textContent = (discYield * 100).toFixed(2) + '%';

    document.getElementById('tbInvPrice').textContent = fmtMoney(invPrice);
    document.getElementById('tbInvAmt').textContent = fmtMoney(invAmt);
    document.getElementById('tbInvYield').textContent = (invYield * 100).toFixed(2) + '%';

    /* normalised comparison and bps understatement */
    var bpsUnderstate = (discYield - rate) * 10000; /* disc yield > quoted rate, shows understatement of rate vs true */
    /* More precisely: disc basis quotes 'rate' but true yield is discYield — difference is how much disc basis understates */
    var understateBps = (discYield - rate) * 10000;
    var cmpHtml = '<span class="muted">Both expressed as annualised yield on purchase price:</span>';
    cmpHtml += ' &nbsp; <span style="color:#fbbf24">Disc basis true yield: <strong>' + (discYield * 100).toFixed(2) + '%</strong></span>';
    cmpHtml += ' &nbsp; <span style="color:#10b981">Inv yield: <strong>' + (invYield * 100).toFixed(2) + '%</strong></span>';
    cmpHtml += ' &nbsp; <span style="color:#f87171">Disc basis understates true yield by <strong>' + understateBps.toFixed(1) + ' bps</strong></span>';
    document.getElementById('tbComparison').innerHTML = cmpHtml;
}

document.getElementById('s4Days').addEventListener('input', updateTBill);
document.getElementById('s4Rate').addEventListener('input', updateTBill);
[document.getElementById('s4Days'), document.getElementById('s4Rate')].forEach(function(s) {
    s.addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: true });
    s.addEventListener('touchmove', function(e) { e.stopPropagation(); }, { passive: true });
});

/* ══════════════════════════════════════════════════════════════
   Section 5: Real vs Nominal — Fisher Equation
   ══════════════════════════════════════════════════════════════ */
var cvs5 = document.getElementById('realCanvas');
var ctx5 = cvs5.getContext('2d');
var W5 = cvs5.width, H5 = cvs5.height;
var PAD5 = { left: 70, right: 30, top: 30, bottom: 50 };

function drawReal() {
    var rNom = parseInt(document.getElementById('s5Nom').value) / 100;
    var pi   = parseInt(document.getElementById('s5Inf').value) / 100;
    var T    = parseInt(document.getElementById('s5Time').value);
    document.getElementById('v5Nom').textContent  = Math.round(rNom * 100) + '%';
    document.getElementById('v5Inf').textContent  = Math.round(pi * 100) + '%';
    document.getElementById('v5Time').textContent = T + ' yrs';

    /* Fisher exact real rate */
    var rReal = (1 + rNom) / (1 + pi) - 1;
    var rApprox = rNom - pi;

    var plotW = W5 - PAD5.left - PAD5.right;
    var plotH = H5 - PAD5.top - PAD5.bottom;

    /* end values */
    var nomEnd  = Math.pow(1 + rNom, T);
    var realEnd = Math.pow(1 + rReal, T);
    var yMax = nomEnd * 1.12;
    if (yMax < 2) yMax = 2;

    function tx(x) { return PAD5.left + (x / T) * plotW; }
    function ty(y) { return PAD5.top + plotH - (y / yMax) * plotH; }

    ctx5.clearRect(0, 0, W5, H5);
    ctx5.fillStyle = '#0a0a1a';
    ctx5.fillRect(0, 0, W5, H5);

    /* grid */
    ctx5.strokeStyle = 'rgba(255,255,255,0.04)'; ctx5.lineWidth = 1;
    var yStep = niceStep(yMax, 6);
    for (var yv = 0; yv <= yMax; yv += yStep) {
        var py = ty(yv);
        ctx5.beginPath(); ctx5.moveTo(PAD5.left, py); ctx5.lineTo(W5 - PAD5.right, py); ctx5.stroke();
        ctx5.fillStyle = '#505068'; ctx5.font = '10px Georgia'; ctx5.textAlign = 'right'; ctx5.textBaseline = 'middle';
        ctx5.fillText(fmtMoney(yv), PAD5.left - 8, py);
    }
    var xStep = niceStep(T, 8);
    for (var xv = 0; xv <= T; xv += xStep) {
        var px = tx(xv);
        ctx5.strokeStyle = 'rgba(255,255,255,0.04)';
        ctx5.beginPath(); ctx5.moveTo(px, PAD5.top); ctx5.lineTo(px, H5 - PAD5.bottom); ctx5.stroke();
        ctx5.fillStyle = '#505068'; ctx5.font = '10px Georgia'; ctx5.textAlign = 'center'; ctx5.textBaseline = 'top';
        ctx5.fillText(xv + 'y', px, H5 - PAD5.bottom + 8);
    }

    /* axes */
    ctx5.strokeStyle = 'rgba(255,255,255,0.18)'; ctx5.lineWidth = 1.5;
    ctx5.beginPath(); ctx5.moveTo(PAD5.left, PAD5.top); ctx5.lineTo(PAD5.left, H5 - PAD5.bottom); ctx5.lineTo(W5 - PAD5.right, H5 - PAD5.bottom); ctx5.stroke();

    /* inflation erosion fill between the two curves */
    ctx5.beginPath();
    var steps = Math.max(T * 4, 100);
    for (var i = 0; i <= steps; i++) {
        var t = (i / steps) * T;
        ctx5.lineTo(tx(t), ty(Math.pow(1 + rNom, t)));
    }
    for (var i = steps; i >= 0; i--) {
        var t = (i / steps) * T;
        ctx5.lineTo(tx(t), ty(Math.pow(1 + rReal, t)));
    }
    ctx5.closePath();
    ctx5.fillStyle = 'rgba(248,113,113,0.07)';
    ctx5.fill();

    /* nominal curve — green */
    ctx5.strokeStyle = '#10b981'; ctx5.lineWidth = 2.2;
    ctx5.beginPath();
    for (var i = 0; i <= steps; i++) {
        var t = (i / steps) * T;
        var py = ty(Math.pow(1 + rNom, t));
        if (py < PAD5.top) py = PAD5.top;
        if (i === 0) ctx5.moveTo(tx(t), py); else ctx5.lineTo(tx(t), py);
    }
    ctx5.stroke();

    /* real curve — red */
    ctx5.strokeStyle = '#f87171'; ctx5.lineWidth = 2.2;
    ctx5.beginPath();
    for (var i = 0; i <= steps; i++) {
        var t = (i / steps) * T;
        var py = ty(Math.pow(1 + rReal, t));
        if (py < PAD5.top) py = PAD5.top;
        if (i === 0) ctx5.moveTo(tx(t), py); else ctx5.lineTo(tx(t), py);
    }
    ctx5.stroke();

    /* gap annotation at end */
    var ynomEnd = ty(nomEnd), yrealEnd = ty(realEnd);
    var xEnd = tx(T) + 8;
    if (ynomEnd >= PAD5.top + 10 && nomEnd !== realEnd) {
        ctx5.strokeStyle = 'rgba(248,113,113,0.35)'; ctx5.lineWidth = 1; ctx5.setLineDash([3,3]);
        ctx5.beginPath(); ctx5.moveTo(xEnd, ynomEnd); ctx5.lineTo(xEnd, yrealEnd); ctx5.stroke();
        ctx5.setLineDash([]);
        ctx5.fillStyle = '#f87171'; ctx5.font = '10px "Courier New",monospace'; ctx5.textAlign = 'left'; ctx5.textBaseline = 'middle';
        ctx5.fillText('inflation cost: \u2212' + fmtMoney(nomEnd - realEnd), xEnd + 4, (ynomEnd + yrealEnd) / 2);
    }

    /* results */
    var resHtml = '<span class="muted">Nominal:</span> <span class="green">' + pct(rNom) + '</span>';
    resHtml += ' &nbsp;&nbsp; <span class="muted">Inflation (&pi;):</span> <span style="color:#f87171">' + pct(pi) + '</span>';
    resHtml += ' &nbsp;&nbsp; <span class="muted">Real (exact):</span> <span style="color:#fbbf24">' + pct(rReal) + '</span>';
    resHtml += ' &nbsp;&nbsp; <span class="muted">Real (approx):</span> <span style="color:#a78bfa">' + pct(rApprox) + '</span>';
    resHtml += '<br><span class="muted">After ' + T + ' yrs nominal:</span> <span class="green">' + fmtMoney(nomEnd) + '</span>';
    resHtml += ' &nbsp;&nbsp; <span class="muted">real purchasing power:</span> <span style="color:#f87171">' + fmtMoney(realEnd) + '</span>';
    document.getElementById('realResults').innerHTML = resHtml;

    /* insight */
    var pct_lost = (1 - realEnd / nomEnd) * 100;
    var insHtml = 'A nominal return of <strong>' + Math.round(rNom * 100) + '%</strong> with inflation at <strong>' + Math.round(pi * 100) + '%</strong> delivers a real return of only <strong style="color:#fbbf24">' + pct(rReal) + '</strong> (Fisher exact). ';
    insHtml += 'Over ' + T + ' years, <strong>' + pct_lost.toFixed(1) + '%</strong> of your nominal gains are eroded by inflation &mdash; the shaded gap above. ';
    if (rReal <= 0) {
        insHtml += '<strong style="color:#f87171">Warning: real return is negative. Inflation is outpacing the nominal rate &mdash; purchasing power is shrinking.</strong>';
    } else {
        insHtml += 'The Fisher approximation (r<sub>real</sub> &asymp; r<sub>nom</sub> &minus; &pi;) gives <strong>' + pct(rApprox) + '</strong> &mdash; accurate when inflation is low, increasingly imprecise as &pi; rises.';
    }
    document.getElementById('realInsight').innerHTML = insHtml;
}

['s5Nom','s5Inf','s5Time'].forEach(function(id) {
    document.getElementById(id).addEventListener('input', drawReal);
    document.getElementById(id).addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: true });
    document.getElementById(id).addEventListener('touchmove', function(e) { e.stopPropagation(); }, { passive: true });
});

/* ══════════════════════════════════════════════════════════════
   Initialise
   ══════════════════════════════════════════════════════════════ */
drawGrowth();
drawFreq();
drawDiscount();
updateTBill();
drawReal();
</script>
<footer style="text-align:center;padding:28px 20px 18px;color:#505068;font-size:0.72em;line-height:1.7;border-top:1px solid rgba(255,255,255,0.04);margin-top:30px">
    <div>&copy; 2025&ndash;2026 Manoj Bhaskar &middot; Coded by <a href="https://claude.ai/claude-code" style="color:#606078;text-decoration:none" target="_blank" rel="noopener">Claude</a> &middot; <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:#606078;text-decoration:none" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div>
</footer>
</body>
</html>
